<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tell Them This Isn’t Working</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h1 {
      text-align: center;
      font-size: 2.8em;
      color: #cc0000;
      margin-bottom: 20px;
    }
    .intro {
      background: #f0f5ff;
      padding: 15px 20px;
      border-left: 5px solid #003f7d;
      border-radius: 5px;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: inherit;
      min-height: 44px;
    }
    textarea { resize: vertical; }
    input:focus, textarea:focus, button:focus { outline: 2px solid #005fa3; outline-offset: 2px; }
    .issue-list {
      border: 1px solid #ccc;
      background: #f1f1f1;
      padding: 15px 20px;
      margin-top: 20px;
      border-radius: 5px;
    }
    .issue-list label { font-weight: 600; margin: 8px 0; font-size: 1.05em; display: flex; align-items: center; }
    .issue-list input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); }
    .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .row > label { margin: 0; }
    .hint { font-size: 0.95em; color: #555; margin-top: 6px; }
    button {
      margin-top: 25px;
      padding: 14px 24px;
      font-size: 1.1em;
      background-color: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      transition: background-color 0.3s ease;
      min-height: 44px;
      font-family: inherit;
    }
    button:hover { background-color: #005fa3; }
    #mailtoLink {
      display: inline-block;
      margin-top: 30px;
      font-weight: bold;
      font-size: 1.1em;
      background-color: #0077cc;
      color: white;
      padding: 12px 18px;
      border-radius: 6px;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }
    #mailtoLink:hover { background-color: #005fa3; }
    footer { margin-top: 50px; border-top: 1px solid #ddd; padding-top: 20px; font-size: 0.95em; color: #444; }
    @media (max-width: 600px) {
      body { padding: 20px; }
      label { font-size: 1.05em; }
      input[type="text"], textarea { font-size: 1em; padding: 12px; }
      button { font-size: 1em; padding: 12px 20px; }
      .row { gap: 8px; }
    }
  </style>
</head>
<body>
  <div style="background: linear-gradient(90deg, #0051a3, #0077cc); padding: 30px 20px; border-radius: 12px; text-align: center; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <h1 style="color: white; font-size: 2.5em; margin: 0;">Tell Them This Isn’t Working</h1>
    <p style="color: #e0f0ff; font-size: 1.1em; margin-top: 8px;">Real Voices. Real Streets. Real Problems.</p>
  </div>

  <div class="intro">
    <strong>Why does this tool exist?</strong><br><br>
    This tool helps you send a clear, personal email about how the pavement parking ban is working in practice on your street—without writing from scratch. Every message is unique and harder to dismiss. Add your details, tick the issues that apply, and we’ll open a ready‑to‑send email to your representatives.
  </div>

  <form>
    <label for="name">Your Name:</label>
    <input type="text" id="name" placeholder="e.g. Robert Bruce" autocomplete="name" required>

    <label for="address">Your Address:</label>
    <input type="text" id="address" placeholder="e.g. 6 Charlotte Square" autocomplete="street-address" required>

    <label for="postcode">Postcode:</label>
    <input type="text" id="postcode" placeholder="e.g. EH2 4DR" autocomplete="postal-code" required>

    <div class="issue-list" aria-labelledby="issuesHeading">
      <strong id="issuesHeading">Select the concerns that affect your street:</strong>
      <label><input type="checkbox" id="selectAll"> Select all</label>
      <label><input type="checkbox" value="emergency"> 🚑 Emergency vehicles could be blocked</label>
      <label><input type="checkbox" value="accessibility"> ♿️ Accessibility needs not considered</label>
      <label><input type="checkbox" value="prams"> 🧒 Children and prams forced to share reduced road space</label>
      <label><input type="checkbox" value="bins"> 🚮 Bin collections missed or disrupted</label>
      <label><input type="checkbox" value="elderly"> 🧓 Elderly residents struggling with distance to car</label>
      <label><input type="checkbox" value="visitors"> 🏠 Visitors and tradespeople can’t park</label>
      <label><input type="checkbox" value="danger"> ⚠️ Danger now worse than before</label>
      <label><input type="checkbox" value="blocked"> 🗑️ Pavements already blocked by council bins</label>
      <label><input type="checkbox" value="gardens"> 🌱 People paving over gardens due to pressure for parking</label>
      <label><input type="checkbox" value="blanket"> ❌ Blanket enforcement punishes everyone</label>
      <label><input type="checkbox" value="consultation"> 🧾 No consultation with residents</label>
      <label><input type="checkbox" value="cohesion"> 🧱 Policy damaging social cohesion</label>
      <label><input type="checkbox" value="blanket20mph"> 🚗 Blanket 20mph limit being imposed</label>
      <div class="hint">Tick only the points that actually apply to your street.</div>
    </div>

    <div class="row" style="margin-top: 14px;">
      <label><input type="checkbox" id="plainMode"> Plain email (no emojis)</label>
      <label><input type="checkbox" id="includeAgenda"> Include wider policy concerns</label>
    </div>

    <label for="other" style="margin-top: 12px;">Write your own concerns:</label>
    <textarea id="other" rows="4" placeholder="Write anything else you want to include..."></textarea>

    <button type="button" id="openBtn">Open Email</button>
  </form>

  <footer>
    <p>This tool helps you contact your MSPs and councillors about the practical effects of the pavement parking ban on your street. You can personalise the content further once it opens in your email client.</p>
  </footer>

<script>
  // --- Generic, hedged variants (street-agnostic) ---
  const issues = {
    emergency: [
      "I’m concerned emergency vehicles may be delayed when all parking is pushed fully onto the carriageway. On many residential streets, that reduces manoeuvring space at the very moment seconds matter.",
      "Emergency access appears tighter when vehicles cannot use the kerb edge at all. Larger vehicles like ambulances and fire engines have less room to pass safely and quickly.",
      "Shifting every car fully onto the road narrows usable space for responders. I don’t think that was the intention, but it’s an outcome we should take seriously."
    ],
    accessibility: [
      "People with reduced mobility, temporary injuries, or pushchairs often need to park near home. With limited alternatives, the rules are making everyday life harder for those who already face challenges.",
      "For residents who can’t comfortably walk longer distances, the change reduces accessibility in practice, rather than improving it.",
      "Those using walking aids or managing health conditions now face longer and more difficult routes between car and door. That isn’t a more inclusive outcome."
    ],
    prams: [
      "Where pavements are uneven or already constrained, families with prams are being pushed to share narrower road space. That feels less safe than before.",
      "With all vehicles fully on‑road and pavements still cluttered at times, the available space for prams and young children is tighter and more stressful to navigate.",
      "The intention was safer walking, but the practical result is prams moving closer to moving traffic on many streets."
    ],
    bins: [
      "Waste collection seems harder, not easier. Narrower passing gaps mean larger vehicles must edge through tight spaces, raising the risk of scrapes, delays, and missed uplifts.",
      "Bin lorries are having to negotiate narrower approaches, sometimes mounting the kerb to proceed. That doesn’t feel safer or more sustainable.",
      "Essential services are affected too. When the carriageway is fully occupied, access for waste vehicles is more difficult and damage risk rises."
    ],
    elderly: [
      "For older residents, extra distance between car and home is a genuine barrier. The policy doesn’t seem to account for that day‑to‑day reality.",
      "What looks like a short walk on paper can be a major obstacle in practice for elderly neighbours. We should support independence, not reduce it.",
      "Nearby parking helps older residents remain active and connected. Removing that option makes ordinary tasks significantly tougher."
    ],
    visitors: [
      "Visitors, carers, and tradespeople struggle to stop legally and practically. This complicates repairs, care visits, and family support.",
      "Everyday life is harder when there’s nowhere reasonable for carers or trades to pause. Tight timing and equipment needs aren’t reflected in the current setup.",
      "Hosting visitors or arranging work now means navigating restrictions that don’t fit real‑world needs."
    ],
    danger: [
      "Rather than improving safety, the new layout can increase tension and reduce visibility. Passing and reversing feel riskier in tighter lanes.",
      "When all parking is forced onto the carriageway, sightlines shorten and close‑call risks rise—especially near junctions and bends.",
      "In practice, narrower lanes and fewer refuge options for pedestrians don’t feel like a safer outcome."
    ],
    blocked: [
      "Pavements are often obstructed by council bins—especially on collection days. It’s inconsistent to penalise residents while this recurring obstruction isn’t addressed.",
      "Many pavements are already difficult to use several days a week due to bins left out. If access is the goal, that needs solving too.",
      "The policy’s stated aim is pedestrian access, yet routine bin placement already blocks pavements. That double standard should be resolved."
    ],
    gardens: [
      "Some neighbours feel pressured to pave front gardens to create driveways. That reduces greenery, harms drainage, and diminishes the street’s character.",
      "We’re seeing more hardstanding where gardens used to be, driven by necessity rather than choice. That’s a poor environmental trade‑off.",
      "Driveway conversions are increasing because residents feel they have no workable alternative, which isn’t a sustainable outcome."
    ],
    blanket: [
      "A single rule is being applied to very different streets and contexts. That feels like automation, not proportionate enforcement.",
      "Parking that functioned safely for years is now penalised, while genuine obstructions aren’t distinguished. Flexibility and judgement are missing.",
      "Universal prohibition treats unlike situations the same. We need discretion that recognises local layouts and lived experience."
    ],
    consultation: [
      "There hasn’t been meaningful, street‑level consultation. Residents most affected haven’t been properly engaged before rollout.",
      "People weren’t asked how the change would work in practice where they live. It arrived first, with dialogue afterwards—if at all.",
      "Major changes like this should include local voices early. That hasn’t happened in a way people recognise."
    ],
    cohesion: [
      "Where neighbours previously cooperated informally, we now anticipate more complaints and friction. That erodes a sense of community.",
      "This is creating conflict over limited space as people try to comply with a rigid rule. That’s not how strong neighbourhoods are built.",
      "Parking used to be managed with courtesy and common sense. The new approach is driving a wedge between people on the same street."
    ],
    blanket20mph: [
      "A blanket 20mph rollout is being applied regardless of local context or risk. Slowing traffic in high‑risk areas makes sense; applying the same rule everywhere without clear evidence or an enforcement focus is harder to justify—especially alongside the parking changes."
    ]
  };
</script>

<script>
  // --- Subject lines (more neutral, compact options appended) ---
  const subjectLines = [
    "Real concerns from my street",
    "This policy isn’t working here",
    "The pavement ban is making things worse",
    "Please pause and review the parking ban",
    "We need practical solutions, not blanket rules",
    "Local voices are being ignored",
    "Parking changes have gone too far",
    "A dangerous shift on our street",
    "Why this ban isn’t helping our community",
    "The unintended harm of the pavement ban",
    "Enforcement without flexibility is failing us",
    "This is hurting vulnerable residents",
    "Please look again at this policy",
    "My community needs a rethink",
    "This ban makes our road more dangerous",
    "The council’s bins block pavements too",
    "Parking reform, not punishment",
    "Consult us — don’t ignore us",
    "This doesn’t work for real people",
    "The policy isn’t achieving its aims",
    "It’s not safer — just harder",
    "Where’s the balance for residents?",
    "Bad policy, good intentions",
    "Everyday life is harder now",
    "The policy forgot about us",
    "Parking is now a daily problem",
    "Rethink needed — urgently",
    "It’s hurting people who follow the rules",
    "My street is worse off",
    "Too much enforcement, not enough sense",
    "No room for bin lorries, no room for help",
    "Why is this being forced on us?",
    "I support access — this isn’t it",
    "What about real safety?",
    "This isn’t working on our street",
    "You need to see what’s happening here",
    "Your constituents are struggling",
    "Council created this mess",
    "Practical parking is gone",
    "This needs fixed before more harm is done",
    "Please rethink this ban",
    "Not all streets are the same",
    "A blanket rule is the wrong tool",
    "You must hear our concerns",
    "Look at the real world impacts",
    "This causes division, not safety",
    "Parking policy gone wrong",
    "Stop treating us all the same",
    "We were not consulted",
    "I support access — but not this way",
    // added neutrals
    "Local impacts of parking rules",
    "Practical fixes needed on our street",
    "Resident feedback on pavement parking ban",
    "Evidence‑led adjustments requested",
    "Access and safety: unintended effects",
    "Please review local outcomes",
    "Street‑level issues and options",
    "One size doesn’t fit our street",
    "Safer access needs flexibility",
    "Consult residents before enforcing",
    "Let’s trial workable alternatives",
    "Seeking proportionate enforcement"
  ];
</script>

<script>
  // --- Data loading & helpers ---
  async function init() {
    window.isReady = false;

    const mspData = await fetch('mspContacts.json').then(res => res.json());

    const normalize = str => str?.toLowerCase().replace(/[^a-z0-9]/g, '').trim();
    window.normalize = normalize;

    window.apiKey = "6946df58f97fd1b9aad7493a65c4cf8cbc8ddb3b"; // Democracy Club / MapIt key already provisioned
    window._mspData = mspData;

    const normalizedRegions = {};
    Object.keys(mspData.regions).forEach(regionName => {
      normalizedRegions[normalize(regionName)] = mspData.regions[regionName];
    });
    mspData.regions = normalizedRegions;

    window.mspData = mspData;
    window.isReady = true;
  }

  function toggleAllIssues(source) {
    const checkboxes = document.querySelectorAll('.issue-list input[type="checkbox"]');
    checkboxes.forEach(cb => { if (cb.id !== 'selectAll') cb.checked = source.checked; });
  }

  async function getEmailsFromPostcode(postcode) {
    const url = `https://mapit.mysociety.org/postcode/${encodeURIComponent(postcode)}?api_key=${window.apiKey}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Postcode lookup failed.');
    const data = await res.json();
    const areas = data.areas || {};

    let spc = null, spe = null;
    for (const area of Object.values(areas)) {
      if (area.type === 'SPC') spc = area.name;
      if (area.type === 'SPE') spe = area.name;
    }

    const mspKey = Object.keys(window._mspData.constituencies).find(key => window.normalize(key) === window.normalize(spc));
    const msp = mspKey ? window._mspData.constituencies[mspKey] : null;
    const regionalMSPs = window._mspData.regions[window.normalize(spe)] || [];

    const normalizedPostcode = window.normalize(postcode);
    const postcodePrefix = postcode.trim().toUpperCase().split(' ')[0];
    let councillors = [];

    const jsPath = `data/${postcodePrefix}.js`;
    try {
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = jsPath;
        script.onload = () => resolve();
        script.onerror = () => reject(`Failed to load script: ${jsPath}`);
        document.head.appendChild(script);
      });
      councillors = window.postcodeToWardKey?.[normalizedPostcode] || [];
    } catch (err) {
      console.warn(err);
    }

    return { msps: [msp, ...regionalMSPs].filter(Boolean), councillors };
  }

  function stripEmojis(s) {
    return s.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, '').replace(/\s{2,}/g, ' ').trim();
  }

  const mitigationCore =
    "Please pause enforcement on residential streets where the rules are clearly creating practical problems, and open an evidence‑led consultation with residents. Either amend the legislation and guidance to allow workable, signposted solutions on suitable streets (e.g., marked partial‑kerb tolerances, designated bays, time‑based allowances), or accept that a blanket approach is unworkable and repeal it.";

  const mitigationAgendaOptional =
    "Some of us are also concerned about the wider policy direction behind these changes. If wider aims are influencing local decisions, that should be discussed openly with residents rather than assumed.";

  const openers = [
    (n,a,p)=>`My name is ${n}, and I live at ${a}, ${p}. I’m writing about how the pavement parking ban is working in practice on residential streets like ours. The intention is understood, but the day‑to‑day effects are creating avoidable problems.`,
    (n,a,p)=>`I’m ${n} at ${a}, ${p}. I support safer access, but the current approach is creating avoidable problems on our street.`,
    (n,a,p)=>`${n} here from ${a}, ${p}. The intention behind the ban is clear; the outcomes on our street are not working as hoped.`
  ];

  function buildMessage({ name, address, postcode, chosenLines, includeAgenda=false, plain=false }) {
    const newline = '\n\n';
    const greeting = 'Dear Councillors and MSPs,';
    const opening = openers[Math.floor(Math.random()*openers.length)](name,address,postcode);
    const concerns = `Specific concerns from our area include:${newline}${chosenLines.join(newline)}`;
    const asks = mitigationCore + (includeAgenda ? (' ' + mitigationAgendaOptional) : '');
    const close = 'I’d appreciate a response on what you can do in the short term to relieve these pressures, and how residents will be involved in shaping a practical, fair, and safe approach.';

    let body = `${greeting}${newline}${opening}${newline}${concerns}${newline}${asks}${newline}Kind regards,${newline}${name}`;
    if (plain) body = stripEmojis(body);
    return body;
  }

  window.generateEmail = async function () {
    if (!window.isReady) {
      alert('Still loading data. Please wait a moment and try again.');
      return;
    }

    const name = document.getElementById('name').value.trim();
    const address = document.getElementById('address').value.trim();
    const postcode = document.getElementById('postcode').value.trim();
    const other = document.getElementById('other').value.trim();
    const includeAgenda = document.getElementById('includeAgenda').checked;
    const plainMode = document.getElementById('plainMode').checked;

    const allCheckboxes = document.querySelectorAll('.issue-list input[type="checkbox"]');
    const checkboxes = Array.from(allCheckboxes).filter(cb => cb.checked && cb.id !== 'selectAll');

    if (!name || !address || !postcode) {
      alert('Please fill in your name, address, and postcode.');
      return;
    }

    if (checkboxes.length === 0 && !other) {
      alert('Please select at least one concern or fill in the other box.');
      return;
    }

    const selectedSubjects = checkboxes.map(cb => cb.value);
    let chosenLines = selectedSubjects.map(issue => {
      const options = issues[issue];
      return options[Math.floor(Math.random() * options.length)];
    });

    if (other) chosenLines.push(other);
    if (plainMode) chosenLines = chosenLines.map(stripEmojis);

    const message = buildMessage({ name, address, postcode, chosenLines, includeAgenda, plain: plainMode });
    const subject = subjectLines[Math.floor(Math.random() * subjectLines.length)];

    try {
      const repData = await getEmailsFromPostcode(postcode);

      const emails = [];
      if (repData.msps?.length) repData.msps.forEach(msp => { if (msp.email) emails.push(msp.email); });
      if (repData.councillors?.length) repData.councillors.forEach(c => { if (c.email) emails.push(c.email); });

      if (emails.length === 0) {
        alert('We couldn’t find any email contacts for that postcode.');
        return;
      }

      const ccAddress = 'thepavementtrap@gmail.com';
      const body = encodeURIComponent(message.replace(/\n/g, '\r\n'));
      const mailtoLink = `mailto:${emails.join(',')}?cc=${encodeURIComponent(ccAddress)}&subject=${encodeURIComponent(subject)}&body=${body}`;

      const tempLink = document.createElement('a');
      tempLink.href = mailtoLink;
      tempLink.style.display = 'none';
      document.body.appendChild(tempLink);
      tempLink.click();
      document.body.removeChild(tempLink);

      setTimeout(() => {
        alert('If your email app didn’t open, please check your browser settings or copy the text manually.');
      }, 1000);
    } catch (error) {
      console.error('Error fetching representatives:', error);
      alert('Something went wrong looking up your representatives. Please double-check the postcode.');
    }
  };

  document.getElementById('selectAll').addEventListener('click', function () {
    const isChecked = this.checked;
    const checkboxes = document.querySelectorAll('.issue-list input[type="checkbox"]');
    checkboxes.forEach(cb => { if (cb.id !== 'selectAll') cb.checked = isChecked; });
  });

  document.getElementById('openBtn').addEventListener('click', () => window.generateEmail());

  init();
</script>
</body>
</html>
