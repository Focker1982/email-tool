<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tell Them This Isnâ€™t Working</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Open Sans', sans-serif; background-color: #f8f9fa; color: #333; max-width: 900px; margin: 40px auto; padding: 30px; border-radius: 10px; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    h1 { text-align: center; font-size: 2.5em; color: #cc0000; margin-bottom: 20px; }
    .intro { background: #e7f1fc; padding: 15px 20px; border-left: 5px solid #0051a3; border-radius: 5px; margin-bottom: 25px; }
    label { display: block; margin: 12px 0 6px; font-weight: 600; }
    input[type="text"], textarea { width: 100%; padding: 10px; font-size: 1em; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; min-height: 44px; }
    textarea { resize: vertical; }
    input:focus, textarea:focus, button:focus { outline: 2px solid #005fa3; outline-offset: 2px; }
    .issue-list { border: 1px solid #ccc; background: #f1f1f1; padding: 15px 20px; margin-top: 20px; border-radius: 5px; }
    .issue-list label { font-weight: 600; margin: 8px 0; font-size: 1.05em; display: flex; align-items: center; }
    .issue-list input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); }
    button { margin-top: 25px; padding: 14px 24px; font-size: 1.1em; background-color: #0077cc; color: white; border: none; cursor: pointer; border-radius: 6px; transition: background-color 0.3s ease; min-height: 44px; font-family: inherit; }
    button:hover { background-color: #005fa3; }
    footer { margin-top: 40px; border-top: 1px solid #ddd; padding-top: 16px; font-size: 0.95em; color: #444; }
    @media (max-width: 600px) {
      body { padding: 20px; }
      input[type="text"], textarea { font-size: 1em; padding: 12px; }
      button { font-size: 1em; padding: 12px 20px; }
    }
  </style>
</head>
<body>
  <div style="background: linear-gradient(90deg, #0051a3, #0077cc); padding: 30px 20px; border-radius: 12px; text-align: center; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <h1 style="color: white; font-size: 2.2em; margin: 0;">Tell Them This Isnâ€™t Working</h1>
    <p style="color: #e0f0ff; font-size: 1.05em; margin-top: 8px;">Real Voices. Real Streets. Real Problems.</p>
  </div>

  <div class="intro" style="background: #f0f5ff; border-left: 5px solid #003f7d; margin-top: 40px;">
    <strong>Why does this tool exist?</strong><br><br>
    This tool helps you send a clear, personal email about how the pavement parking changes are playing out on <em>your</em> street. Add your details, tick what applies, and weâ€™ll open a readyâ€‘toâ€‘send email in your own voice â€” practical, proportionate and evidenceâ€‘led.
  </div>

  <form onsubmit="return false;">
    <label for="name">Your Name:</label>
    <input type="text" id="name" placeholder="e.g. Jane Smith" autocomplete="name" required>

    <label for="address">Your Address:</label>
    <input type="text" id="address" placeholder="e.g. 6 Charlotte Square" autocomplete="street-address" required>

    <label for="postcode">Postcode:</label>
    <input type="text" id="postcode" placeholder="e.g. EH2 4DR" autocomplete="postal-code" required>

    <div class="issue-list">
      <strong>Select the concerns that affect your street:</strong>
      <label><input type="checkbox" id="selectAll"> ğŸ”˜ Select all</label>
      <label><input type="checkbox" value="emergency"> ğŸš‘ Emergency vehicles could be blocked</label>
      <label><input type="checkbox" value="danger"> âš ï¸ Tighter lanes and worse sightlines</label>
      <label><input type="checkbox" value="accessibility"> â™¿ï¸ Reduced mobility not accommodated</label>
      <label><input type="checkbox" value="prams"> ğŸ§’ Prams and kids squeezed into traffic</label>
      <label><input type="checkbox" value="elderly"> ğŸ§“ Older neighbours lose nearby access</label>
      <label><input type="checkbox" value="visitors"> ğŸ  Trades, carers and visitors struggle</label>
      <label><input type="checkbox" value="bins"> ğŸš® Bin collections delayed or risky</label>
      <label><input type="checkbox" value="blocked"> ğŸ—‘ï¸ Pavements blocked by council bins</label>
      <label><input type="checkbox" value="gardens"> ğŸŒ± Pressure to pave over gardens</label>
      <label><input type="checkbox" value="blanket"> âŒ Oneâ€‘sizeâ€‘fitsâ€‘all enforcement</label>
      <label><input type="checkbox" value="consultation"> ğŸ§¾ Little or no consultation</label>
      <label><input type="checkbox" value="cohesion"> ğŸ§± Strain on neighbour relations</label>
      <label><input type="checkbox" value="opposeIdeology"> ğŸ›‘ Reject 20â€‘minute city frameworks</label>
      <label><input type="checkbox" value="blanket20mph"> ğŸš— Reject blanket 20â€¯mph limits</label>
    </div>

    <label for="other">Write your own concern (optional):</label>
    <textarea id="other" rows="4" placeholder="Streetâ€‘specific evidence, examples or dates you want includedâ€¦"></textarea>

    <button id="openEmailBtn" type="button">Open Email</button>
  </form>

  <footer>
    <p>This tool opens your email client with your MSPs and councillors preâ€‘filled (where available). You can still edit the message before sending.</p>
  </footer>

<!-- ===== Data (short, onâ€‘point lines) ===== -->
<script>
var issues = {
  emergency: [
    "Full onâ€‘road parking narrows access and risks delaying ambulances or fire engines when seconds matter.",
    "Emergency vehicles need turning space â€” forcing all cars onto the road removes it at critical pinch points.",
    "Response times suffer when larger vehicles canâ€™t pass. The layout builds delay into emergencies."
  ],
  danger: [
    "Shifting all parking onto the road creates tighter lanes, poorer sightlines and more close calls.",
    "Safety hasnâ€™t improved: visibility is down, stress is up, and passing or reversing is riskier.",
    "Narrowed lanes leave less escape space for pedestrians and drivers â€” thatâ€™s not safer."
  ],
  accessibility: [
    "People with reduced mobility lose nearby parking and face longer, harder walks with no workable alternative.",
    "This creates barriers for anyone who canâ€™t manage distance or uneven routes â€” itâ€™s less inclusive, not more.",
    "Those using walking aids or recovering from injury now face tougher, longer routes from car to door."
  ],
  prams: [
    "Families with prams are pushed into tighter traffic space while pavements remain cluttered or uneven.",
    "Usable space for prams and small children is smaller and riskier than before.",
    "Where pavements arenâ€™t practical, concentrating cars on the carriageway squeezes families into danger."
  ],
  elderly: [
    "Longer walks with shopping or mobility issues are not trivial â€” they remove independence for older residents.",
    "Removing nearby parking adds daily strain many canâ€™t manage.",
    "Access to a closeâ€‘by space is what lets many older neighbours cope â€” the policy takes that away."
  ],
  visitors: [
    "Trades, carers and visitors struggle to stop nearby, disrupting basic home support and repairs.",
    "Routine shortâ€‘stays become impractical, which reduces support and community contact.",
    "With few shortâ€‘stay options, essential visits take longer or donâ€™t happen."
  ],
  bins: [
    "Bin lorries face tighter gaps, leading to delays, missed collections and more scrapes.",
    "Narrowed access makes collections unreliable and increases the risk of damage.",
    "Essential services shouldnâ€™t have to mount kerbs to get through â€” the layout pushes them to."
  ],
  blocked: [
    "Council bins already block pavements on collection days â€” yet residents are blamed for access issues.",
    "If bins make pavements impassable several days a week, enforcement feels inconsistent and unfair.",
    "Pedestrian access canâ€™t improve while pavements are routinely obstructed by council bins."
  ],
  gardens: [
    "Pressure for legal parking pushes people to pave gardens, harming drainage and green space.",
    "Driveway conversions rise out of pressure, not choice â€” bad for biodiversity and flood risk.",
    "Replacing greenery with hardstanding is a direct outcome of an inflexible policy."
  ],
  blanket: [
    "Oneâ€‘sizeâ€‘fitsâ€‘all enforcement ignores street context and penalises responsible parking.",
    "Focus should be on genuine obstructions, not blanket punishment.",
    "A universal ban treats all streets the same â€” discretion and flexibility are needed."
  ],
  consultation: [
    "Residents werenâ€™t properly consulted before rollout, despite being directly affected.",
    "Local voices were sidelined; streetâ€‘level evidence wasnâ€™t gathered first.",
    "A change this big needed real engagement and testing; it didnâ€™t happen."
  ],
  cohesion: [
    "Removing informal, workable arrangements fuels neighbour disputes and complaints.",
    "Strict rules on scarce space strain community goodwill.",
    "Support for local, commonâ€‘sense solutions maintains cohesion; blanket rules donâ€™t."
  ],
  opposeIdeology: [
    "I reject 20â€‘minute cityâ€“style planning where it restricts everyday access. Remove it from transport policy.",
    "Do not use 20â€‘minute city frameworks to set parking or access rules â€” they donâ€™t reflect how people live and work.",
    "Withdraw 20â€‘minute city principles from local access planning; replace with practical, streetâ€‘tested solutions."
  ],
  blanket20mph: [
    "I reject a universal 20â€¯mph limit. Replace it with targeted limits where real risk justifies it.",
    "Blanket 20â€¯mph zones should be reversed and replaced with evidenceâ€‘based, locationâ€‘specific speeds.",
    "Keep existing limits where appropriate; use 20â€¯mph only where data shows itâ€™s needed."
  ]
};

var impactOpeners = [
  "The pavement parking changes are making our street harder to use safely and practically.",
  "On our street, the pavement parking changes arenâ€™t working as intended.",
  "These rules are affecting everyday access and safety on our street.",
  "As applied, the pavement parking rules are not working for our street.",
  "If enforced as planned, these rules would reduce access and safety on our street.",
  "In practice, this policy isnâ€™t achieving safer, more accessible conditions on our street."
];

var subjectLines = [
  "Request for review of pavement parking policy",
  "Pause and review to improve street access",
  "Local impacts and needed adjustments to parking rules",
  "Evidence from residents on pavement parking changes",
  "Making parking rules work for all users",
  "Balancing safety and access on local streets",
  "Call for practical review of parking restrictions",
  "How to deliver safer, more accessible streets",
  "Ensuring policy matches real street conditions",
  "Request for pause before full enforcement",
  "Working together to fix unintended impacts",
  "Practical solutions for safer local streets"
];
</script>

<!-- ===== Legacyâ€‘safe logic (no modern JS) ===== -->
<script>
  // Simple XHR JSON helper
  function xhrGetJSON(url, cb) {
    var x = new XMLHttpRequest();
    x.open("GET", url, true);
    x.onreadystatechange = function () {
      if (x.readyState === 4) {
        if (x.status >= 200 && x.status < 300) {
          try { cb(null, JSON.parse(x.responseText)); } catch (e) { cb(e); }
        } else {
          cb(new Error("HTTP " + x.status));
        }
      }
    };
    try { x.send(); } catch (e) { cb(e); }
  }

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function normalize(s){ s = (s || ""); if (s.toLowerCase) s = s.toLowerCase(); return s.replace(/[^a-z0-9]/g,'').trim(); }

  // Deâ€‘dupe nearâ€‘identical sentences by first ~12 words
  function dedupeByStem(lines){
    var seen = {};
    var out = [];
    for (var i=0;i<lines.length;i++){
      var key = String(lines[i]).toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).slice(0,12).join(' ');
      if (!seen[key]) { seen[key] = 1; out.push(lines[i]); }
    }
    return out;
  }

  // Keep joins disabled to avoid awkward â€œMeanwhile, Thisâ€¦â€ phrasing
  function fuseShort(lines){ return lines; }

  // Clean and add user's "Other" line
  function cleanOther(text) {
    var t = (text || "").replace(/\s+/g,' ').replace(/^[\.!?,;:]+|[\.!?,;:]+$/g,'').trim();
    if (!t) return "";
    var keep = { "MSP":1,"MSPs":1,"NHS":1,"HGV":1,"EV":1,"EVs":1,"DYL":1 };
    t = t.replace(/\b([A-Z]{4,})\b/g, function(m){ return keep[m] ? m : m.charAt(0) + m.slice(1).toLowerCase(); });
    if (!/[\.!?]$/.test(t)) t += ".";
    return "In addition, " + t;
  }
  function isDuplicateOfAny(text, lines){
    var stem = String(text).toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).slice(0,12).join(' ');
    for (var i=0;i<lines.length;i++){
      var s2 = String(lines[i]).toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).slice(0,12).join(' ');
      if (s2 === stem) return true;
    }
    return false;
  }

  // Globals
  window.isReady = false;
  window._mspData = null;
  window.apiKey = "6946df58f97fd1b9aad7493a65c4cf8cbc8ddb3b";

  // Init MSP data
  function init(){
    window.isReady = false;
    xhrGetJSON("mspContacts.json", function(err, mspData){
      if (!err && mspData) {
        var normalized = {};
        var k;
        for (k in mspData.regions) {
          if (mspData.regions.hasOwnProperty(k)) {
            normalized[normalize(k)] = mspData.regions[k];
          }
        }
        mspData.regions = normalized;
        window._mspData = mspData;
      }
      window.isReady = true;
    });
  }

  // MapIt + councillors (optional data/*.js)
  function getEmailsFromPostcode(postcode, done){
    var url = "https://mapit.mysociety.org/postcode/" + encodeURIComponent(postcode) + "?api_key=" + window.apiKey;
    xhrGetJSON(url, function(err, data){
      if (err) return done(err);
      var areas = data && data.areas ? data.areas : {};
      var spc = null, spe = null, k, a;
      for (k in areas) {
        if (!areas.hasOwnProperty(k)) continue;
        a = areas[k];
        if (a.type === "SPC") spc = a.name;
        if (a.type === "SPE") spe = a.name;
      }
      var list = [];
      if (window._mspData && window._mspData.constituencies && spc) {
        for (k in window._mspData.constituencies) {
          if (!window._mspData.constituencies.hasOwnProperty(k)) continue;
          if (normalize(k) === normalize(spc)) { list.push(window._mspData.constituencies[k]); break; }
        }
      }
      if (window._mspData && window._mspData.regions && spe) {
        var region = window._mspData.regions[normalize(spe)] || [];
        for (var i=0;i<region.length;i++) list.push(region[i]);
      }

      var councillors = [];
      var prefix = String(postcode).trim().toUpperCase().split(" ")[0];
      var jsPath = "data/" + prefix + ".js";

      var s = document.createElement("script");
      var finished = false;
      function finish(){
        if (finished) return; finished = true;
        try {
          var np = normalize(postcode);
          if (window.postcodeToWardKey && window.postcodeToWardKey[np]) {
            councillors = window.postcodeToWardKey[np];
          }
        } catch(e){}
        return done(null, { msps: list, councillors: councillors });
      }
      s.onload = function(){ setTimeout(finish, 0); };
      s.onerror = function(){ setTimeout(finish, 0); };
      try { s.src = jsPath; document.head.appendChild(s); } catch(e){ finish(); }
      setTimeout(finish, 2500);
    });
  }

  // Selectâ€‘all
  function toggleAllIssues(source) {
    var boxes = document.querySelectorAll(".issue-list input[type='checkbox']");
    for (var i=0;i<boxes.length;i++){
      var cb = boxes[i];
      if (cb.id !== "selectAll") cb.checked = !!source.checked;
    }
  }

  // Generate email
  function generateEmail(){
    if (!window.isReady) { alert("Still loading data. Please wait a moment and try again."); return; }

    var name = (document.getElementById("name").value || "").trim();
    var address = (document.getElementById("address").value || "").trim();
    var postcode = (document.getElementById("postcode").value || "").trim();
    var other = (document.getElementById("other").value || "").trim();

    var all = document.querySelectorAll(".issue-list input[type='checkbox']");
    var selected = [];
    for (var i=0;i<all.length;i++){
      if (all[i].checked && all[i].id !== "selectAll") selected.push(all[i].value);
    }

    if (!name || !address || !postcode) { alert("Please fill in your name, address, and postcode."); return; }
    if (selected.length === 0 && !other) { alert("Please select at least one concern or add your own."); return; }

    // Priority order (so key points appear earlier)
    var priority = [
      "emergency","danger",
      "accessibility","prams","elderly",
      "visitors",
      "bins","blocked",
      "gardens",
      "blanket","consultation","cohesion",
      "opposeIdeology","blanket20mph"
    ];
    var ordered = [];
    for (var p=0;p<priority.length;p++){ if (selected.indexOf(priority[p]) !== -1) ordered.push(priority[p]); }
    for (var j=0;j<selected.length;j++){ if (priority.indexOf(selected[j]) === -1) ordered.push(selected[j]); }

    var lines = [];
    for (var m=0;m<ordered.length;m++){
      var key = ordered[m];
      var opts = issues[key] || [];
      if (opts.length) lines.push(opts[Math.floor(Math.random()*opts.length)]);
    }

    if (other) {
      var otherLine = cleanOther(other);
      if (!isDuplicateOfAny(otherLine, lines)) lines.push(otherLine);
    }

    lines = dedupeByStem(lines);
    lines = fuseShort(lines);
    // No paragraph cap â€” include everything selected.

    var greetings = ["Dear MSPs and Councillors,","Dear Councillors and MSPs,"];
    var bridges = ["Based on what weâ€™re seeing, the realâ€‘world impacts are:","In practice on our street, this has meant:","Day to day, the effects are clear:"];
    var signoffs = ["Regards,","Yours sincerely,","Kind regards,"];
    var greet = pick(greetings), bridge = pick(bridges), signoff = pick(signoffs);

    var opener = pick(impactOpeners);
    var newline = "\n\n";

    var mitigation = "I am asking Councillors and MSPs to work together to fix this quickly. Please pause enforcement where it creates risk or reduces access, lead a rapid, evidenceâ€‘led review with residents and essential services, and make the necessary changes in both arenas â€” update local traffic orders, exemptions and enforcement practice, and press Ministers for national amendments so legislation and guidance reflect realâ€‘world conditions. The aim is simple: safe, genuinely accessible streets without avoidable harm to residents, services or the street environment.";

    var message = ""
      + greet + newline
      + "My name is " + name + ", and I live at " + address + ", " + postcode + "." + newline
      + opener + " Residents have adapted over the years to keep streets workable for everyone, but these changes risk undoing that balance. " + bridge + newline
      + lines.join(newline) + newline
      + mitigation + newline
      + signoff + newline
      + name;

    var subject = subjectLines[Math.floor(Math.random()*subjectLines.length)];

    getEmailsFromPostcode(postcode, function(err, reps){
      if (err) { console.error(err); alert("Representative lookup failed. Please doubleâ€‘check the postcode."); return; }
      var emails = [];
      if (reps && reps.msps) { for (var i=0;i<reps.msps.length;i++){ if (reps.msps[i] && reps.msps[i].email) emails.push(reps.msps[i].email); } }
      if (reps && reps.councillors) { for (var k=0;k<reps.councillors.length;k++){ if (reps.councillors[k] && reps.councillors[k].email) emails.push(reps.councillors[k].email); } }

      if (!emails.length) { alert("We couldnâ€™t find any email contacts for that postcode."); return; }

      var ccAddress = "thepavementtrap@gmail.com";
      var body = message.replace(/\n/g, "%0D%0A");
      var link = "mailto:" + emails.join(",") + "?cc=" + encodeURIComponent(ccAddress) + "&subject=" + encodeURIComponent(subject) + "&body=" + body;

      var a = document.createElement("a");
      a.href = link; a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      setTimeout(function(){ alert("If your email app didnâ€™t open, please check your browser settings or copy the text manually."); }, 1000);
    });
  }

  // Wire up events
  document.getElementById("selectAll").addEventListener("click", function(){ toggleAllIssues(this); });
  document.getElementById("openEmailBtn").addEventListener("click", generateEmail);

  // Go
  init();
</script>
</body>
</html>
