<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tell Them This Isn’t Working</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Open Sans', sans-serif; background-color: #f8f9fa; color: #333; max-width: 900px; margin: 40px auto; padding: 30px; border-radius: 10px; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    h1 { text-align: center; font-size: 2.5em; color: #cc0000; margin-bottom: 20px; }
    .intro { background: #e7f1fc; padding: 15px 20px; border-left: 5px solid #0051a3; border-radius: 5px; margin-bottom: 25px; }
    label { display: block; margin: 12px 0 6px; font-weight: 600; }
    input[type="text"], textarea { width: 100%; padding: 10px; font-size: 1em; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; min-height: 44px; }
    textarea { resize: vertical; }
    input:focus, textarea:focus, button:focus { outline: 2px solid #005fa3; outline-offset: 2px; }
    .issue-list { border: 1px solid #ccc; background: #f1f1f1; padding: 15px 20px; margin-top: 20px; border-radius: 5px; }
    .issue-list label { font-weight: 600; margin: 8px 0; font-size: 1.05em; display: flex; align-items: center; }
    .issue-list input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); }
    button { margin-top: 25px; padding: 14px 24px; font-size: 1.1em; background-color: #0077cc; color: white; border: none; cursor: pointer; border-radius: 6px; transition: background-color 0.3s ease; min-height: 44px; font-family: inherit; }
    button:hover { background-color: #005fa3; }
    footer { margin-top: 50px; border-top: 1px solid #ddd; padding-top: 20px; font-size: 0.95em; color: #444; }
    @media (max-width: 600px) {
      body { padding: 20px; }
      label { font-size: 1.05em; }
      input[type="text"], textarea { font-size: 1em; padding: 12px; }
      button { font-size: 1em; padding: 12px 20px; }
    }
  </style>
</head>
<body>
  <div style="background: linear-gradient(90deg, #0051a3, #0077cc); padding: 30px 20px; border-radius: 12px; text-align: center; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <h1 style="color: white; font-size: 2.2em; margin: 0;">Tell Them This Isn’t Working</h1>
    <p style="color: #e0f0ff; font-size: 1.05em; margin-top: 8px;">Real Voices. Real Streets. Real Problems.</p>
  </div>

  <div class="intro" style="background: #f0f5ff; border-left: 5px solid #003f7d; margin-top: 40px;">
    <strong>Why does this tool exist?</strong><br><br>
    This tool helps you send a clear, personal email about how the pavement parking ban (and related policies) are playing out on <em>your</em> street. Tick the issues that apply and we’ll open a ready‑to‑send email to your representatives — practical, proportionate and evidence‑led.
  </div>

  <form>
    <label for="name">Your Name:</label>
    <input type="text" id="name" placeholder="e.g. Robert Bruce" autocomplete="name" required>

    <label for="address">Your Address:</label>
    <input type="text" id="address" placeholder="e.g. 6 Charlotte Square" autocomplete="street-address" required>

    <label for="postcode">Postcode:</label>
    <input type="text" id="postcode" placeholder="e.g. EH2 4DR" autocomplete="postal-code" required>

    <div class="issue-list">
      <strong>Select the concerns that affect your street:</strong>
      <label><input type="checkbox" id="selectAll"> 🔘 Select all</label>
      <label><input type="checkbox" value="emergency"> 🚑 Emergency vehicle access</label>
      <label><input type="checkbox" value="danger"> ⚠️ Safety & sightlines</label>
      <label><input type="checkbox" value="accessibility"> ♿ Accessibility & mobility</label>
      <label><input type="checkbox" value="prams"> 🧒 Prams & young children</label>
      <label><input type="checkbox" value="elderly"> 🧓 Older neighbours’ access</label>
      <label><input type="checkbox" value="visitors"> 🏠 Family, friends & local trades</label>
      <label><input type="checkbox" value="bins"> 🚮 Bin collection & services</label>
      <label><input type="checkbox" value="blocked"> 🗑 Pavements blocked by council bins</label>
      <label><input type="checkbox" value="gardens"> 🌱 Loss of greenery / paving over gardens</label>
      <label><input type="checkbox" value="blanket"> ❌ One‑size‑fits‑all enforcement</label>
      <label><input type="checkbox" value="consultation"> 🧾 Limited consultation</label>
      <label><input type="checkbox" value="cohesion"> 🧱 Community cohesion</label>
      <label><input type="checkbox" value="opposeIdeology"> 🛑 Reject 20‑minute city frameworks</label>
      <label><input type="checkbox" value="blanket20mph"> 🚗 Reject blanket 20 mph</label>
    </div>

    <label for="other">Write your own concerns:</label>
    <textarea id="other" rows="4" placeholder="Add any street‑specific evidence, examples or dates you want included…"></textarea>

    <button type="button" id="openEmail">Open Email</button>
  </form>

  <footer>
    <p>This tool opens your email client with a draft you can edit. Each message varies the intro, phrasing and examples so it’s harder to dismiss as copy‑paste.</p>
  </footer>

<script>
/* ===== Dynamic sentence bank (kept from your latest version, lightly sharpened) ===== */
const issues = {
  emergency: [
    "Forcing all cars onto the road removes passing and turning space when seconds matter for blue‑light access.",
    "Once parking fills the carriageway, fire and ambulance vehicles struggle at pinch points and response times can slip.",
    "Critical space and turning circles are lost when the road is narrowed by displaced parking — that’s an emergency access risk."
  ],
  danger: [
    "This policy hasn’t made our street safer. It’s created narrower lanes, reduced escape space for pedestrians, and made passing or reversing more dangerous than before.",
    "By forcing all parking onto the road, the policy increases the chance of collisions and close calls — particularly where visibility is already limited.",
    "Visibility is worse and space is tighter; what used to be a calm residential route now feels more stressful for drivers and pedestrians alike."
  ],
  accessibility: [
    "Many residents, including the elderly and those recovering from injury, rely on being able to park near their homes. With limited legal alternatives, the ban makes daily life more difficult.",
    "There are no practical nearby options for those who can’t easily walk longer distances; the result is less accessibility, not more.",
    "Those with walking aids, temporary injuries, or pushchairs now face longer, more difficult routes between car and door — often with no safe option."
  ],
  prams: [
    "On streets where pavements are already obstructed or uneven, full on‑road parking forces prams and young children into the carriageway, making every journey riskier.",
    "Families who used to share space carefully now find less road width and no safe workaround once all parking is pushed on‑road.",
    "Rather than protecting families, this policy pushes children and prams into live traffic where partial kerb parking once gave them a buffer."
  ],
  elderly: [
    "For older residents, having to walk further with shopping or mobility issues is a serious challenge; removing nearby parking undermines independence.",
    "That extra distance isn’t just inconvenient — it’s a real barrier for older people managing day‑to‑day tasks.",
    "Even a short walk can be daunting with limited mobility; removing proximity parking doesn’t feel like progress."
  ],
  visitors: [
    "When family, friends, trades or local businesses can’t park nearby, everyday life suffers — from childcare and school runs to helping an older relative.",
    "Restricting short‑stay parking makes it harder for families to connect, friends to visit, and local services to deliver — it chips away at community life.",
    "Losing the ability to stop close to someone’s home undermines everyday support networks and essential local services."
  ],
  bins: [
    "The current layout makes waste collection harder: large vehicles must squeeze through narrow gaps or mount the kerb, increasing delays and minor damage.",
    "Narrowed roads and awkward angles force council vehicles into difficult positions — often onto pavements to get past.",
    "Bin lorries struggle when streets are fully occupied by on‑road parking; incidental damage and missed collections become more likely."
  ],
  blocked: [
    "We’re banned from using the pavement to keep the road clear, yet council bins block pavements for days — and all that space is now lost on the road as well.",
    "Pavements can be impassable for days due to council bin storage, but residents are penalised for the same thing when trying to keep the street workable.",
    "It makes no sense to ban partial pavement use while council bins routinely block them; the result is less space on both pavement and road."
  ],
  gardens: [
    "The pressure to find legal parking is leading residents to pave over front gardens, harming drainage, biodiversity and the character of the street.",
    "More hardstanding means worse drainage, less greenery, and a less welcoming street scene — an avoidable side‑effect of inflexible rules.",
    "Driveway conversions are happening not because people want them, but because they feel forced — leaving harder, less green streets and higher flood risk."
  ],
  blanket: [
    "A universal ban treats all situations the same, regardless of context. We need flexibility and discretion — not one‑size‑fits‑all enforcement.",
    "Parking that worked safely for years is being criminalised; enforcement should focus on real obstructions, not routine, practical parking.",
    "Applying the same rule to every street — whatever its layout or history — isn’t sensible enforcement."
  ],
  consultation: [
    "This was introduced without meaningful street‑level consultation; those directly affected were left out.",
    "There’s been little honest engagement; residents weren’t asked how the ban would impact them — they were told after the fact.",
    "Major change should include local voices and evidence before rollout."
  ],
  cohesion: [
    "Strict rules on scarce space strain community goodwill and cooperation.",
    "Removing informal arrangements over limited space creates avoidable disputes.",
    "Community cohesion is easier to maintain when local solutions are supported alongside policy."
  ],
  opposeIdeology: [
    "I do not support the application of 20‑minute city–style planning where it restricts everyday access; it should be removed from transport policy.",
    "20‑minute city frameworks should not shape street‑level parking or access; they don’t reflect residents’ needs in practice.",
    "I reject the use of 20‑minute city principles in access planning; where applied, they should be withdrawn in favour of practical, street‑tested solutions."
  ],
  blanket20mph: [
    "I do not support a universal 20 mph limit; it should be reversed in favour of targeted limits where genuinely needed.",
    "Blanket 20 mph zones should be replaced by speed management based on actual local risk.",
    "Retaining existing limits with targeted interventions would be more proportionate than a universal 20 mph."
  ]
};

/* ===== Subject lines (kept tight and on‑point) ===== */
const subjectLines = [
  "Request for review of pavement parking policy",
  "Pause and review to improve street access",
  "Balancing safety and access on local streets",
  "Practical fixes for safer, accessible streets",
  "Evidence from residents: current approach isn’t working"
];

/* ===== Grouping logic ===== */
const CATEGORIES = [
  { key: "safety", title: "Safety & Emergency Access", members: ["emergency","danger"] },
  { key: "mobility", title: "Mobility & Everyday Access", members: ["accessibility","prams","elderly","visitors","bins","blocked"] },
  { key: "community", title: "Community & Wider Impacts", members: ["gardens","blanket","consultation","cohesion"] },
  { key: "policy", title: "Wider policy concerns", members: ["opposeIdeology","blanket20mph"] }
];

/* ===== Dynamic intro lines (rotating) ===== */
const introVariants = [
  "I’m writing because the current approach — pushing all parking onto the carriageway and removing partial‑kerb parking — reduces passing width without fixing blocked pavements. It isn’t working as intended on our street.",
  "In practice, moving every car fully onto the road has cut turning space and narrowed lanes, while pavements remain obstructed on key days. That’s not delivering safer or more accessible conditions here.",
  "As applied locally, the rule change concentrates parking on the carriageway and removes the buffer partial kerb parking provided. Day‑to‑day, that’s making our street harder to use safely and practically."
];

/* ===== Helper utils ===== */
const pick = arr => arr[Math.floor(Math.random() * arr.length)];
function sanitizePostcode(pc){ return String(pc||"").toUpperCase().replace(/[^A-Z0-9]/g,"").replace(/(.{3})$/," $1").trim(); }

/* ===== Rep lookup (unchanged) ===== */
let isReady = false, mspData, apiKey = "6946df58f97fd1b9aad7493a65c4cf8cbc8ddb3b";
const normalize = s => s ? s.toLowerCase().replace(/[^a-z0-9]/g,'').trim() : '';

async function init() {
  isReady = false;
  mspData = await fetch('mspContacts.json').then(r => r.json());
  // normalise region keys
  const norm = {};
  Object.keys(mspData.regions).forEach(n => norm[normalize(n)] = mspData.regions[n]);
  mspData.regions = norm;
  isReady = true;
}

function toggleAllIssues(source) {
  const boxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  boxes.forEach(cb => { if (cb.id !== 'selectAll') cb.checked = source.checked; });
}

async function getEmailsFromPostcode(postcodeInput) {
  const formatted = sanitizePostcode(postcodeInput);
  const url = `https://mapit.mysociety.org/postcode/${encodeURIComponent(formatted)}?api_key=${apiKey}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Postcode lookup failed.");
  const data = await res.json();

  let spc=null, spe=null;
  for (const area of Object.values(data.areas)) {
    if (area.type === "SPC") spc = area.name;
    if (area.type === "SPE") spe = area.name;
  }

  const mspKey = Object.keys(mspData.constituencies).find(k => normalize(k) === normalize(spc));
  const msp = mspKey ? mspData.constituencies[mspKey] : null;
  const regionalMSPs = mspData.regions[normalize(spe)] || [];

  // Councillors via local JS map (by outward code)
  const outward = formatted.split(' ')[0];
  let councillors = [];
  try {
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = `data/${outward}.js`;
      s.onload = () => resolve();
      s.onerror = () => reject(`Failed to load data/${outward}.js`);
      document.head.appendChild(s);
    });
    councillors = (window.postcodeToWardKey && window.postcodeToWardKey[normalize(formatted)]) || [];
  } catch(e) {
    console.warn(e);
  }

  return { msps: [msp, ...regionalMSPs].filter(Boolean), councillors };
}

/* ===== Build grouped email ===== */
function buildGroupedBody(selectedKeys, otherText) {
  const newline = "\n\n";
  const name = document.getElementById("name").value.trim();
  const address = document.getElementById("address").value.trim();
  const postcode = sanitizePostcode(document.getElementById("postcode").value.trim());

  const greeting = "Dear MSPs and Councillors,";
  const intro = `My name is ${name}, and I live at ${address}, ${postcode}.\n\n${pick(introVariants)}`;

  // Build category sections
  let sections = [];
  for (const cat of CATEGORIES) {
    const membersChosen = cat.members.filter(k => selectedKeys.includes(k));
    if (!membersChosen.length) continue;

    const lines = membersChosen.map(k => {
      const arr = issues[k] || [];
      return arr.length ? "— " + pick(arr) : null;
    }).filter(Boolean);

    if (!lines.length) continue;

    // Policy section uses no heading if only one policy line? We still add a heading for clarity.
    sections.push(`${cat.title}:\n\n${lines.join("\n")}`);
  }

  // Add user's custom note if provided
  let extra = "";
  if (otherText && otherText.trim()) {
    const t = otherText.trim();
    extra = `\n\nAdditional local note:\n\n— ${t.endsWith('.') ? t : t + '.'}`;
  }

  // Joint-action closer
  const closer = "I am asking Councillors and MSPs to work together to fix this quickly. Please pause enforcement where it creates risk or reduces access, lead a rapid, evidence‑led review with residents and essential services, and make the necessary changes in both arenas — update local traffic orders, exemptions and enforcement practice, and press Ministers for national amendments so legislation and guidance reflect real‑world conditions. The aim is simple: safe, genuinely accessible streets without avoidable harm to residents, services or the street environment.";

  const signoff = "Yours sincerely,\n" + name;

  return `${greeting}\n\n${intro}\n\n${sections.join("\n\n")}${extra}\n\n${closer}\n\n${signoff}`;
}

/* ===== Wire up UI ===== */
document.getElementById('selectAll').addEventListener('click', function(){
  toggleAllIssues(this);
});

document.getElementById('openEmail').addEventListener('click', async function(){
  if (!isReady) { alert("Still loading data. Please wait a moment and try again."); return; }

  const name = document.getElementById("name").value.trim();
  const address = document.getElementById("address").value.trim();
  const postcode = document.getElementById("postcode").value.trim();
  const other = document.getElementById("other").value.trim();

  if (!name || !address || !postcode) {
    alert("Please fill in your name, address and postcode.");
    return;
  }

  const allBoxes = Array.from(document.querySelectorAll(".issue-list input[type='checkbox']"))
    .filter(cb => cb.id !== 'selectAll');

  const selectedKeys = allBoxes.filter(cb => cb.checked).map(cb => cb.value);

  if (selectedKeys.length === 0 && !other) {
    alert("Please tick at least one concern or add your own note.");
    return;
  }

  // Build message
  const bodyText = buildGroupedBody(selectedKeys, other);

  // Lookup recipients
  try {
    const repData = await getEmailsFromPostcode(postcode);
    const emails = [];
    if (repData.msps && repData.msps.length) repData.msps.forEach(m => { if (m.email) emails.push(m.email); });
    if (repData.councillors && repData.councillors.length) repData.councillors.forEach(c => { if (c.email) emails.push(c.email); });

    if (!emails.length) {
      alert("We couldn’t find any email contacts for that postcode.");
      return;
    }

    const subject = pick(subjectLines);
    const ccAddress = "thepavementtrap@gmail.com";
    const mailto = "mailto:" + emails.join(",") +
      "?cc=" + encodeURIComponent(ccAddress) +
      "&subject=" + encodeURIComponent(subject) +
      "&body=" + encodeURIComponent(bodyText);

    // Open email client
    const a = document.createElement('a');
    a.href = mailto;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

  } catch (e) {
    console.error(e);
    alert("Something went wrong looking up your representatives. Please double‑check the postcode.");
  }
});

init();
</script>
</body>
</html>
