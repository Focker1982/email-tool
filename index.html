<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tell Them This Isnâ€™t Working</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: #cc0000;
      margin: 0;
    }
    .subhead {
      color: #335;
      text-align: center;
      margin: 8px 0 24px;
      font-size: 1.05em;
    }
    .intro {
      background: #f0f5ff;
      padding: 15px 20px;
      border-left: 5px solid #003f7d;
      border-radius: 5px;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: inherit;
      min-height: 44px;
    }
    textarea { resize: vertical; }
    input:focus, textarea:focus, button:focus {
      outline: 2px solid #005fa3;
      outline-offset: 2px;
    }
    .issue-list {
      border: 1px solid #ccc;
      background: #f7f7f7;
      padding: 15px 20px;
      margin-top: 10px;
      border-radius: 6px;
    }
    .issue-list strong { display:block; margin-bottom: 8px; }
    .issue-list label {
      font-weight: 600;
      margin: 6px 0;
      font-size: 1.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .issue-list input[type="checkbox"] { transform: scale(1.15); }
    button {
      margin-top: 22px;
      padding: 14px 24px;
      font-size: 1.05em;
      background-color: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      transition: background-color 0.3s ease;
      min-height: 44px;
      font-family: inherit;
    }
    button:hover { background-color: #005fa3; }
    footer {
      margin-top: 28px;
      border-top: 1px solid #ddd;
      padding-top: 16px;
      font-size: 0.95em;
      color: #444;
    }
    @media (max-width: 600px) {
      body { padding: 20px; }
      input[type="text"], textarea { padding: 12px; }
      button { padding: 12px 20px; }
    }
  </style>
</head>
<body>
  <div style="background: linear-gradient(90deg, #0051a3, #0077cc); padding: 26px 18px; border-radius: 12px; text-align: center; margin-bottom: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
    <h1>Tell Them This Isnâ€™t Working</h1>
    <div class="subhead">Real Voices. Real Streets. Real Problems.</div>
  </div>

  <div class="intro">
    <strong>Why this exists</strong><br>
    This tool helps you contact your MSPs and councillors without writing from scratch. Every email is unique, personal, and harder to dismiss as copyâ€‘andâ€‘paste.
  </div>

  <form>
    <label for="name">Your Name</label>
    <input type="text" id="name" placeholder="e.g. Alex Taylor" autocomplete="name" required>

    <label for="address">Your Address</label>
    <input type="text" id="address" placeholder="e.g. 6 Charlotte Square" autocomplete="street-address" required>

    <label for="postcode">Postcode</label>
    <input type="text" id="postcode" placeholder="e.g. EH2 4DR" autocomplete="postal-code" required>

    <div class="issue-list">
      <strong>Select the concerns that affect your street:</strong>
      <label><input type="checkbox" id="selectAll"> ğŸ”˜ Select all</label>
      <label><input type="checkbox" value="emergency"> ğŸš‘ Emergency vehicles could be blocked</label>
      <label><input type="checkbox" value="danger"> âš ï¸ Danger now worse than before</label>
      <label><input type="checkbox" value="accessibility"> â™¿ï¸ Accessibility needs not considered</label>
      <label><input type="checkbox" value="prams"> ğŸ§’ Children and prams forced to share reduced road space</label>
      <label><input type="checkbox" value="elderly"> ğŸ§“ Elderly residents struggling with distance to car</label>
      <label><input type="checkbox" value="visitors"> ğŸ  Visitors / carers / trades canâ€™t stop</label>
      <label><input type="checkbox" value="bins"> ğŸš® Bin collections missed or disrupted</label>
      <label><input type="checkbox" value="blocked"> ğŸ—‘ï¸ Pavements blocked by council bins</label>
      <label><input type="checkbox" value="gardens"> ğŸŒ± People paving over gardens</label>
      <label><input type="checkbox" value="blanket"> âŒ Oneâ€‘sizeâ€‘fitsâ€‘all enforcement</label>
      <label><input type="checkbox" value="consultation"> ğŸ§¾ Limited consultation</label>
      <label><input type="checkbox" value="cohesion"> ğŸ§± Social cohesion under strain</label>
      <label><input type="checkbox" value="opposeIdeology"> ğŸ›‘ Set aside 20â€‘minute cityâ€“style frameworks</label>
      <label><input type="checkbox" value="blanket20mph"> ğŸš— Blanket 20â€¯mph applied without local tailoring</label>
    </div>

    <label for="other">Add your own point (optional)</label>
    <textarea id="other" rows="4" placeholder="Add anything specific to your streetâ€¦"></textarea>

    <button type="button" id="openEmailBtn">Open Email</button>
  </form>

  <footer>
    Emails open in your mail app so you can tweak before sending. Subject lines and phrasing rotate each time.
  </footer>

<script>
/* ===== Issue text (kept long/fully detailed) ===== */
const issues = {
  emergency: [
    "Forcing all cars onto the road removes passing and turning space when seconds matter for blueâ€‘light access.",
    "Once parking fills the carriageway, fire and ambulance vehicles struggle at pinch points and response times can slip.",
    "Critical space and turning circles are lost when the road is narrowed by displaced parking â€” thatâ€™s an emergency access risk."
  ],
  danger: [
    "This policy hasnâ€™t made our street safer. Itâ€™s created narrower lanes, reduced escape space for pedestrians, and made passing or reversing more dangerous than before.",
    "Visibility is worse and space is tighter; what used to be a calm residential route now feels more stressful for drivers and pedestrians alike.",
    "By forcing all parking onto the road, the policy increases the chance of collisions and close calls â€” particularly where visibility is already limited. Thatâ€™s not what safer streets look like."
  ],
  accessibility: [
    "Many residents, including the elderly and those recovering from injury, rely on being able to park near their homes. With limited legal alternatives, the ban makes daily life more difficult for people who already face mobility challenges.",
    "This policy creates unfair barriers for anyone with reduced mobility. There are no practical nearby alternatives for those who canâ€™t easily walk longer distances, and the result is a less accessible environment â€” not a more inclusive one.",
    "Those with walking aids, temporary injuries, or pushchairs now face longer, more difficult routes between car and door â€” often with no safe option."
  ],
  prams: [
    "On streets where pavements are already obstructed or uneven, full onâ€‘road parking forces prams and young children into the carriageway, making every journey riskier.",
    "Families used to navigate safely with prams or young kids by sharing space carefully. Now, displaced parking leaves less road space and no safe workaround.",
    "Rather than protecting families, this policy pushes children and prams into live traffic where partial kerb parking once gave them a buffer."
  ],
  elderly: [
    "For older residents, having to walk further with shopping or mobility issues is a serious challenge; removing nearby parking undermines independence.",
    "That extra distance isnâ€™t just inconvenient â€” itâ€™s a real barrier for older people managing dayâ€‘toâ€‘day tasks.",
    "Even a short walk can be daunting with limited mobility; removing proximity parking doesnâ€™t feel like progress."
  ],
  visitors: [
    "When family, friends, trades or local businesses canâ€™t park nearby, everyday life suffers â€” from childcare and school runs to helping an older relative.",
    "Restricting shortâ€‘stay parking makes it harder for families to connect, friends to visit, and local services to deliver â€” it chips away at the fabric of community.",
    "Losing the ability to stop close to someoneâ€™s home undermines everyday support networks â€” grandparents helping with children, friends checking in, and local businesses or trades providing essential services."
  ],
  bins: [
    "The current layout makes waste collection harder: large vehicles must squeeze through narrow gaps or mount the kerb, increasing delays and minor damage.",
    "Narrowed roads and awkward angles force council vehicles into difficult positions â€” often onto pavements to get past.",
    "Bin lorries will have more difficulty accessing streets fully occupied by onâ€‘road parking, and damage to parked cars becomes more likely as a result."
  ],
  blocked: [
    "Pavements can be impassable due to council bin storage, but residents are penalised for adapting to keep the street workable.",
    "Weâ€™re banned from using the pavement to keep the road clear, yet council bins regularly block pavements â€” and all that space is now lost on the road as well.",
    "It makes no sense to ban partial pavement use while council bins routinely block them; the result is less space on both pavement and road."
  ],
  gardens: [
    "Driveway conversions are becoming more common, not because residents want them, but because they feel forced â€” leaving harder, less green streets and higher flood risk.",
    "The pressure to find legal parking is leading residents to pave over front gardens, harming drainage, biodiversity and the character of the street.",
    "More hardstanding means worse drainage, less greenery, and a less welcoming street scene â€” an avoidable sideâ€‘effect of inflexible rules."
  ],
  blanket: [
    "A universal ban treats all situations the same, regardless of context. We need flexibility and discretion â€” not oneâ€‘sizeâ€‘fitsâ€‘all enforcement.",
    "Applying the same rule to every street â€” whatever its layout or history â€” isnâ€™t sensible enforcement.",
    "Parking that worked safely for years is being criminalised; enforcement should focus on real obstructions, not routine, practical parking."
  ],
  consultation: [
    "This was introduced without meaningful streetâ€‘level consultation; those directly affected were left out.",
    "Major change should include local voices and evidence before rollout.",
    "Residents werenâ€™t asked how this would impact them â€” they were told after the fact."
  ],
  cohesion: [
    "Strict rules on scarce space strain community goodwill and cooperation.",
    "Removing informal arrangements over limited space creates avoidable disputes.",
    "Community cohesion is easier to maintain when local solutions are supported alongside policy."
  ],
  opposeIdeology: [
    "I do not support the application of 20â€‘minute cityâ€“style planning where it restricts everyday access; it should be removed from transport policy.",
    "20â€‘minute city frameworks should not shape streetâ€‘level parking or access; they donâ€™t reflect residentsâ€™ needs in practice.",
    "I reject the use of 20â€‘minute city principles in access planning; where applied, they should be withdrawn in favour of practical, streetâ€‘tested solutions."
  ],
  blanket20mph: [
    "I do not support a universal 20â€¯mph limit; it should be reversed in favour of targeted limits where genuinely needed.",
    "Blanket 20â€¯mph zones should be replaced by speed management based on actual local risk.",
    "Retaining existing limits with targeted interventions would be more proportionate than a universal 20â€¯mph."
  ]
};

/* ===== Subject lines (concise & neutral) ===== */
const subjectLines = [
  "Request for review of pavement parking policy",
  "Balancing access and safety on local streets",
  "Evidence from residents on current parking approach",
  "Practical adjustments needed to parking rules",
  "Concerns about the streetâ€‘level impact of the ban",
  "Improving policy outcomes through local review",
  "Please pause and review before full enforcement"
];

/* ===== Dynamic openers (rotate; no bin assumptions) ===== */
const openers = [
  "Pushing every car fully onto the road narrows lanes and removes turning space. Thatâ€™s not safer, and itâ€™s not more accessible.",
  "Concentrating parking on the carriageway removes the buffer partialâ€‘kerb parking provided and tightens passing width.",
  "Moving all parking onto the road creates tighter conditions without a clear gain in accessibility.",
  "As applied locally, the rule change reduces passing space and increases nearâ€‘misses without improving access."
];

/* ===== MSP/councillor lookup boot ===== */
let isReady = false;
let _mspData = null;
const normalize = (str) => str?.toLowerCase().replace(/[^a-z0-9]/g, '').trim();
const apiKey = "6946df58f97fd1b9aad7493a65c4cf8cbc8ddb3b";

async function init() {
  const mspData = await fetch('mspContacts.json').then(r => r.json());
  const normalizedRegions = {};
  Object.keys(mspData.regions).forEach(regionName => {
    normalizedRegions[normalize(regionName)] = mspData.regions[regionName];
  });
  mspData.regions = normalizedRegions;
  _mspData = mspData;
  isReady = true;
}

/* ===== Helpers ===== */
const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
function dedupe(lines) {
  const seen = new Set();
  const out = [];
  for (const line of lines) {
    const key = line.toLowerCase().replace(/\s+/g,' ').trim();
    if (!seen.has(key)) { seen.add(key); out.push(line); }
  }
  return out;
}

/* ===== Toggle all ===== */
document.getElementById("selectAll").addEventListener("click", function () {
  const isChecked = this.checked;
  const checkboxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  checkboxes.forEach(cb => { if (cb.id !== 'selectAll') cb.checked = isChecked; });
});

/* ===== Rep lookup ===== */
async function getEmailsFromPostcode(postcode) {
  const url = `https://mapit.mysociety.org/postcode/${encodeURIComponent(postcode)}?api_key=${apiKey}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Postcode lookup failed.");
  const data = await res.json();
  const areas = data.areas;

  let spc = null, spe = null;
  for (const area of Object.values(areas)) {
    if (area.type === "SPC") spc = area.name;
    if (area.type === "SPE") spe = area.name;
  }

  const mspKey = Object.keys(_mspData.constituencies).find(
    key => normalize(key) === normalize(spc)
  );
  const msp = mspKey ? _mspData.constituencies[mspKey] : null;
  const regionalMSPs = _mspData.regions[normalize(spe)] || [];

  const normalizedPostcode = normalize(postcode);
  const postcodePrefix = postcode.trim().toUpperCase().split(' ')[0];

  let councillors = [];
  const jsPath = `data/${postcodePrefix}.js`;
  try {
    await new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src = jsPath;
      script.onload = () => resolve();
      script.onerror = () => reject(`Failed to load script: ${jsPath}`);
      document.head.appendChild(script);
    });
    councillors = window.postcodeToWardKey?.[normalizedPostcode] || [];
  } catch (err) {
    console.warn(err);
  }

  return { msps: [msp, ...regionalMSPs].filter(Boolean), councillors };
}

/* ===== Dynamic closer (short vs. full) ===== */
function buildCloser(selectedCount) {
  if (selectedCount >= 6) {
    return "Iâ€™m asking Councillors and MSPs to pause enforcement where it reduces access or increases risk, and to review the policy with residents and essential services. Update exemptions, tailor enforcement, and press Ministers for national amendments so rules fit real streets and real needs. The aim is simple: safe, genuinely accessible streets without avoidable harm to residents, services or the street environment.";
  } else {
    return "Please act now: pause enforcement where it causes more harm than good, gather streetâ€‘level evidence, and make the necessary local and national changes so the policy delivers safety and accessibility in reality â€” not just on paper.";
  }
}

/* ===== Build + open email ===== */
async function generateEmail() {
  if (!isReady) { alert("Still loading data. Please wait a moment and try again."); return; }

  const name = document.getElementById("name").value.trim();
  const address = document.getElementById("address").value.trim();
  const postcode = document.getElementById("postcode").value.trim();
  const other = document.getElementById("other").value.trim();

  const allCheckboxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  const selected = Array.from(allCheckboxes).filter(cb => cb.checked && cb.id !== 'selectAll').map(cb => cb.value);

  if (!name || !address || !postcode) { alert("Please fill in your name, address, and postcode."); return; }
  if (selected.length === 0 && !other) { alert("Please select at least one concern or add your own."); return; }

  // Order for narrative flow
  const priority = [
    "emergency","danger",
    "accessibility","prams","elderly","visitors",
    "bins","blocked",
    "gardens","blanket","consultation","cohesion",
    "opposeIdeology","blanket20mph"
  ];
  const ordered = priority.filter(k => selected.includes(k)).concat(selected.filter(k => !priority.includes(k)));

  // One sentence per selected issue
  let lines = ordered.map(key => {
    const arr = issues[key] || [];
    return arr.length ? pick(arr) : null;
  }).filter(Boolean);

  // Add user's extra note if any
  if (other) {
    let t = other.replace(/\s+/g,' ').trim();
    if (!/[.!?]$/.test(t)) t += ".";
    lines.push("In addition, " + t);
  }

  // Dedupe similar/identical lines
  lines = dedupe(lines);

  const newline = "\n\n";
  const greeting = "Dear MSPs and Councillors,";
  const intro = `My name is ${name}, and I live at ${address}, ${postcode}.`;
  const opener = pick(openers);
  const subject = pick(subjectLines);
  const closer = buildCloser(lines.length);

  // Grouping by theme when multiple categories selected
  const groupTitles = {
    emergency: "Safety & Emergency Access:",
    danger: "Safety & Emergency Access:",
    accessibility: "Mobility & Everyday Access:",
    prams: "Mobility & Everyday Access:",
    elderly: "Mobility & Everyday Access:",
    visitors: "Mobility & Everyday Access:",
    bins: "Mobility & Everyday Access:",
    blocked: "Mobility & Everyday Access:",
    gardens: "Community & Wider Impacts:",
    blanket: "Community & Wider Impacts:",
    consultation: "Community & Wider Impacts:",
    cohesion: "Community & Wider Impacts:",
    opposeIdeology: "Wider policy concerns:",
    blanket20mph: "Wider policy concerns:"
  };

  // Split lines back into groups for headings (optional if variety small)
  function buildGroupedBody() {
    const buckets = {};
    ordered.forEach((key) => {
      const title = groupTitles[key] || "Other:";
      if (!buckets[title]) buckets[title] = [];
      const variant = issues[key] && pick(issues[key]);
      if (variant) buckets[title].push(variant);
    });
    if (other) {
      buckets["Other:"] = buckets["Other:"] || [];
      let t = other.replace(/\s+/g,' ').trim();
      if (!/[.!?]$/.test(t)) t += ".";
      buckets["Other:"].push("In addition, " + t);
    }

    // Dedupe within buckets
    Object.keys(buckets).forEach(k => buckets[k] = dedupe(buckets[k]));

    // Build bullet blocks
    let out = "";
    for (const [title, arr] of Object.entries(buckets)) {
      if (!arr.length) continue;
      out += `${title}${newline}`;
      arr.forEach(line => { out += `â€” ${line}${newline}`; });
      out += newline;
    }
    return out.trim();
  }

  // If user picked 3+ different buckets, use grouped format; else flat list
  const pickedBuckets = new Set(ordered.map(k => groupTitles[k]));
  const bodyBlock = (pickedBuckets.size >= 3) ? buildGroupedBody()
               : lines.map(l => `â€” ${l}`).join("\n\n");

  const message =
`${greeting}

${intro}

${opener}

${(pickedBuckets.size >= 3) ? bodyBlock : bodyBlock}

${closer}

Yours sincerely,
${name}`;

  // Lookup recipients & open mailto
  try {
    const repData = await getEmailsFromPostcode(postcode);
    const emails = [];
    if (repData.msps?.length) repData.msps.forEach(m => { if (m.email) emails.push(m.email); });
    if (repData.councillors?.length) repData.councillors.forEach(c => { if (c.email) emails.push(c.email); });

    if (!emails.length) { alert("We couldnâ€™t find any email contacts for that postcode."); return; }

    const ccAddress = "thepavementtrap@gmail.com";
    const body = encodeURIComponent(message);
    const mailtoLink = `mailto:${emails.join(",")}?cc=${encodeURIComponent(ccAddress)}&subject=${encodeURIComponent(subject)}&body=${body}`;

    const a = document.createElement("a");
    a.href = mailtoLink;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  } catch (e) {
    console.error(e);
    alert("Something went wrong looking up your representatives. Please doubleâ€‘check the postcode.");
  }
}

/* ===== Wire up ===== */
document.getElementById("openEmailBtn").addEventListener("click", generateEmail);
init();
</script>
</body>
</html>
