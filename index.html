<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tell Them This Isnâ€™t Working</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: #cc0000;
      margin-bottom: 10px;
    }
    .intro {
      background: #f0f5ff;
      padding: 15px 20px;
      border-left: 5px solid #003f7d;
      border-radius: 6px;
      margin: 25px 0;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: inherit;
      min-height: 44px;
    }
    textarea { resize: vertical; }
    input:focus, textarea:focus, button:focus {
      outline: 2px solid #005fa3;
      outline-offset: 2px;
    }
    .issue-list {
      border: 1px solid #ddd;
      background: #f7f7f7;
      padding: 15px 20px;
      border-radius: 6px;
      margin-top: 10px;
    }
    .issue-list label {
      font-weight: 600;
      margin: 8px 0;
      font-size: 1.02em;
      display: flex;
      align-items: center;
    }
    .issue-list input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.15);
    }
    button {
      margin-top: 20px;
      padding: 14px 22px;
      font-size: 1.05em;
      background-color: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.2s ease;
      min-height: 44px;
      font-family: inherit;
    }
    button:hover { background-color: #005fa3; }
    footer {
      margin-top: 40px;
      border-top: 1px solid #e6e6e6;
      padding-top: 14px;
      font-size: 0.95em;
      color: #555;
    }
    @media (max-width: 600px) {
      body { padding: 20px; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <div style="background: linear-gradient(90deg, #0051a3, #0077cc); padding: 26px 20px; border-radius: 12px; text-align: center; margin-bottom: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
    <h1 style="color: white; margin: 0;">Tell Them This Isnâ€™t Working</h1>
    <p style="color: #e0f0ff; font-size: 1.05em; margin-top: 6px;">Real Voices. Real Streets. Real Problems.</p>
  </div>

  <div class="intro">
    <strong>Why does this tool exist?</strong><br><br>
    This tool makes it easy to add your voice to the campaign â€” without writing from scratch. Every message it creates is unique, personal, and harder for MSPs and councillors to dismiss as copyâ€‘andâ€‘paste.
  </div>

  <form>
    <label for="name">Your Name:</label>
    <input type="text" id="name" placeholder="e.g. Robert Bruce" autocomplete="name" required>

    <label for="address">Your Address:</label>
    <input type="text" id="address" placeholder="e.g. 6 Charlotte Square" autocomplete="street-address" required>

    <label for="postcode">Postcode:</label>
    <input type="text" id="postcode" placeholder="e.g. EH2 4DR" autocomplete="postal-code" required>

    <div class="issue-list">
      <strong>Select the concerns that affect your street:</strong>
      <label><input type="checkbox" id="selectAll"> ğŸ”˜ Select all</label>

      <label><input type="checkbox" value="emergency"> ğŸš‘ Emergency vehicles could be blocked</label>
      <label><input type="checkbox" value="danger"> âš ï¸ Danger now worse than before</label>

      <label><input type="checkbox" value="accessibility"> â™¿ï¸ Accessibility needs not considered</label>
      <label><input type="checkbox" value="prams"> ğŸ§’ Children and prams forced to share reduced road space</label>
      <label><input type="checkbox" value="elderly"> ğŸ§“ Elderly residents struggling with distance to car</label>
      <label><input type="checkbox" value="visitors"> ğŸ  Visitors, family & trades canâ€™t stop nearby</label>

      <label><input type="checkbox" value="bins"> ğŸš® Bin collections missed or disrupted</label>
      <label><input type="checkbox" value="blocked"> ğŸ—‘ï¸ Pavements already blocked by council bins</label>

      <label><input type="checkbox" value="gardens"> ğŸŒ± People paving over gardens due to pressure for parking</label>

      <label><input type="checkbox" value="blanket"> âŒ Oneâ€‘sizeâ€‘fitsâ€‘all enforcement</label>
      <label><input type="checkbox" value="consultation"> ğŸ§¾ Limited consultation</label>
      <label><input type="checkbox" value="cohesion"> ğŸ§± Social cohesion under strain</label>

      <label><input type="checkbox" value="opposeIdeology"> ğŸ›‘ Set aside 20â€‘minute cityâ€“style frameworks</label>
      <label><input type="checkbox" value="blanket20mph"> ğŸš— Blanket 20â€¯mph applied without local tailoring</label>
    </div>

    <label for="other">Write your own concerns:</label>
    <textarea id="other" rows="4" placeholder="Add anything else you want to include..."></textarea>

    <button type="button" id="openEmail">Open Email</button>
  </form>

  <footer>
    This opens your email client with a drafted message you can edit before sending.
  </footer>

<script>
/* ===== Issue sentences (3 variants each where possible) ===== */
var issues = {
  emergency: [
    "Forcing all cars onto the road removes passing and turning space when seconds matter for blueâ€‘light access.",
    "Once parking fills the carriageway, fire and ambulance vehicles struggle at pinch points and response times can slip.",
    "Critical space and turning circles are lost when the road is narrowed by displaced parking â€” thatâ€™s an emergency access risk."
  ],
  danger: [
    "This policy hasnâ€™t made our street safer. Itâ€™s created narrower lanes, reduced escape space for pedestrians, and made passing or reversing more dangerous than before.",
    "By forcing all parking onto the road, the policy increases the chance of collisions and close calls â€” particularly where visibility is already limited.",
    "Narrower lanes and tighter gaps are increasing driver stress and nearâ€‘misses, not reducing them."
  ],
  accessibility: [
    "Those with walking aids, temporary injuries, or pushchairs now face longer, more difficult routes between car and door â€” often with no safe option.",
    "There are no practical nearby options for those who canâ€™t easily walk longer distances; the result is less accessibility, not more.",
    "Removing proximity parking creates a bigger barrier for anyone who canâ€™t manage distance or uneven routes."
  ],
  prams: [
    "On streets where pavements are already obstructed or uneven, full onâ€‘road parking forces prams and young children into the carriageway, making every journey riskier.",
    "Families who used to share space carefully now find less road width and no safe workaround once all parking is pushed onâ€‘road.",
    "Rather than protecting families, this approach pushes children and prams into live traffic where partial kerb parking once provided a buffer."
  ],
  elderly: [
    "For older residents, having to walk further with shopping or mobility issues is a serious challenge; removing nearby parking undermines independence.",
    "That extra distance isnâ€™t just inconvenient â€” itâ€™s a real barrier for older people managing dayâ€‘toâ€‘day tasks.",
    "Even a short walk can be daunting with limited mobility; removing proximity parking doesnâ€™t feel like progress."
  ],
  visitors: [
    "When family, friends, trades or local businesses canâ€™t park nearby, everyday life suffers â€” from childcare and school runs to helping an older relative.",
    "Restricting shortâ€‘stay parking makes it harder for families to connect, friends to visit, and local services to deliver â€” it chips away at community life.",
    "Losing the ability to stop close to someoneâ€™s home undermines everyday support networks â€” grandparents helping with children, friends checking in, and local businesses or trades providing essential services."
  ],
  bins: [
    "The current layout makes waste collection harder: large vehicles must squeeze through narrow gaps or mount the kerb, increasing delays and minor damage.",
    "Bin lorries struggle when streets are fully occupied by onâ€‘road parking; incidental damage and missed collections become more likely.",
    "Narrowed roads and awkward angles force council vehicles into difficult positions â€” often onto pavements to get past."
  ],
  blocked: [
    "Weâ€™re banned from using the pavement to keep the road clear, yet council bins regularly block pavements â€” and all that space is now lost on the road as well.",
    "Pavements can be impassable due to council bin storage, but residents are penalised for adapting to keep the street workable.",
    "It makes no sense to ban partial pavement use while council bins routinely block them â€” the result is less space on both pavement and road."
  ],
  gardens: [
    "The pressure to find legal parking is leading residents to pave over front gardens, harming drainage, biodiversity and the character of the street.",
    "More hardstanding means worse drainage, less greenery, and a less welcoming street scene â€” an avoidable sideâ€‘effect of inflexible rules.",
    "Driveway conversions are becoming more common, not because residents want them, but because they feel forced â€” leaving harder, less green streets and higher flood risk."
  ],
  blanket: [
    "A universal ban treats all situations the same, regardless of context. We need flexibility and discretion â€” not oneâ€‘sizeâ€‘fitsâ€‘all enforcement.",
    "Applying the same rule to every street â€” whatever its layout or history â€” isnâ€™t sensible enforcement.",
    "Parking that worked safely for years is being criminalised; enforcement should focus on real obstructions, not routine, practical parking."
  ],
  consultation: [
    "This was introduced without meaningful streetâ€‘level consultation; those directly affected were left out.",
    "Major change should include local voices and evidence before rollout.",
    "Residents werenâ€™t asked how this would impact them â€” they were told after the fact."
  ],
  cohesion: [
    "Strict rules on scarce space strain community goodwill and cooperation.",
    "Removing informal arrangements over limited space creates avoidable disputes.",
    "Community cohesion is easier to maintain when local solutions are supported alongside policy."
  ],
  opposeIdeology: [
    "I do not support the application of 20â€‘minute cityâ€“style planning where it restricts everyday access; it should be removed from transport policy.",
    "20â€‘minute city frameworks should not shape streetâ€‘level parking or access; they donâ€™t reflect residentsâ€™ needs in practice.",
    "I reject the use of 20â€‘minute city principles in access planning; where applied, they should be withdrawn in favour of practical, streetâ€‘tested solutions."
  ],
  blanket20mph: [
    "I do not support a universal 20â€¯mph limit; it should be reversed in favour of targeted limits where genuinely needed.",
    "Blanket 20â€¯mph zones should be replaced by speed management based on actual local risk.",
    "Retaining existing limits with targeted interventions would be more proportionate than a universal 20â€¯mph."
  ]
};

/* ===== Subject lines (concise & onâ€‘point) ===== */
var subjectLines = [
  "Request for review of pavement parking policy",
  "Pause and review to improve street access",
  "Making parking rules work for residents",
  "Balancing safety and access on local streets",
  "Evidence from residents on current changes",
  "Practical solutions for safer local streets",
  "Improving outcomes through local review",
  "Ensuring policy fits real street conditions"
];

/* ===== Dynamic intro & closer variants ===== */
var introVariants = [
  "Pushing every car fully onto the road cuts turning space, narrows lanes, and adds risk â€” without meaningfully improving pavement access. Thatâ€™s not safer, and itâ€™s not more accessible.",
  "Concentrating all parking on the carriageway removes the buffer that partialâ€‘kerb parking provided, while doing little to improve actual pavement usability. Itâ€™s a step backwards for safety and access.",
  "By removing partialâ€‘kerb parking, the current approach narrows the carriageway and squeezes space for both vehicles and pedestrians â€” without delivering better pedestrian access.",
  "Moving every vehicle fully onto the road has created tighter, more hazardous conditions for drivers and pedestrians alike â€” with no clear gain in pavement accessibility."
];

var closingVariants = [
  "Iâ€™m asking Councillors and MSPs to pause enforcement where it reduces access or increases risk, and to review the policy with residents and essential services. Update exemptions, tailor enforcement, and press Ministers for national amendments so rules fit real streets and real needs.",
  "This policy needs urgent adjustment. Pause enforcement in problem areas, work with communities on practical solutions, and push for changes in law and guidance so we get safe, accessible streets without needless harm to residents or services.",
  "Please act now: halt enforcement where it causes more harm than good, gather evidence from the streets affected, and make the necessary local and national changes so the policy delivers on safety and accessibility in reality â€” not just on paper."
];

/* ===== Data bootstrap ===== */
async function init() {
  window.isReady = false;

  const mspData = await fetch('mspContacts.json').then(res => res.json());

  const normalize = str => (str || '').toLowerCase().replace(/[^a-z0-9]/g, '').trim();
  window.normalize = normalize;

  window.apiKey = "6946df58f97fd1b9aad7493a65c4cf8cbc8ddb3b";
  window._mspData = mspData;

  const normalizedRegions = {};
  Object.keys(mspData.regions).forEach(regionName => {
    normalizedRegions[normalize(regionName)] = mspData.regions[regionName];
  });
  mspData.regions = normalizedRegions;

  window.mspData = mspData;
  window.isReady = true;
}

/* ===== UI helpers ===== */
function toggleAllIssues(source) {
  const checkboxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  checkboxes.forEach(cb => { if (cb.id !== 'selectAll') cb.checked = source.checked; });
}

async function getEmailsFromPostcode(postcode) {
  const url = `https://mapit.mysociety.org/postcode/${encodeURIComponent(postcode)}?api_key=${window.apiKey}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Postcode lookup failed.");
  const data = await res.json();
  const areas = data.areas;

  let spc = null, spe = null;
  for (const area of Object.values(areas)) {
    if (area.type === "SPC") spc = area.name;
    if (area.type === "SPE") spe = area.name;
  }

  const mspKey = Object.keys(window._mspData.constituencies)
    .find(key => window.normalize(key) === window.normalize(spc));
  const msp = mspKey ? window._mspData.constituencies[mspKey] : null;
  const regionalMSPs = window._mspData.regions[window.normalize(spe)] || [];

  const normalizedPostcode = window.normalize(postcode);
  const postcodePrefix = postcode.trim().toUpperCase().split(' ')[0];

  let councillors = [];
  const jsPath = `data/${postcodePrefix}.js`;
  try {
    await new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src = jsPath;
      script.onload = () => resolve();
      script.onerror = () => reject(`Failed to load script: ${jsPath}`);
      document.head.appendChild(script);
    });
    councillors = window.postcodeToWardKey?.[normalizedPostcode] || [];
  } catch (err) {
    console.warn(err);
  }

  return { msps: [msp, ...regionalMSPs].filter(Boolean), councillors };
}

/* ===== Email generator ===== */
window.generateEmail = async function () {
  if (!window.isReady) {
    alert("Still loading data. Please wait a moment and try again.");
    return;
  }

  const name = document.getElementById("name").value.trim();
  const address = document.getElementById("address").value.trim();
  const postcode = document.getElementById("postcode").value.trim();
  const other = document.getElementById("other").value.trim();

  const allCheckboxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  const selected = Array.from(allCheckboxes).filter(cb => cb.checked && cb.id !== 'selectAll');

  if (!name || !address || !postcode) {
    alert("Please fill in your name, address, and postcode.");
    return;
  }
  if (selected.length === 0 && !other) {
    alert("Please select at least one concern or fill in the other box.");
    return;
  }

  const newline = "\n\n";
  const intro = introVariants[Math.floor(Math.random() * introVariants.length)];
  const closer = closingVariants[Math.floor(Math.random() * closingVariants.length)];

  // Section keys
  const sections = {
    "Safety & Emergency Access:": ["emergency", "danger"],
    "Mobility & Everyday Access:": ["accessibility", "prams", "elderly", "visitors", "bins", "blocked"],
    "Community & Wider Impacts:": ["gardens", "blanket", "consultation", "cohesion"],
    "Wider policy concerns:": ["opposeIdeology", "blanket20mph"]
  };

  // Build sections only when they have content
  let sectionText = "";
  for (const [heading, keys] of Object.entries(sections)) {
    const lines = [];

    selected.forEach(cb => {
      if (keys.indexOf(cb.value) !== -1) {
        const variants = issues[cb.value] || [];
        if (variants.length) {
          lines.push(variants[Math.floor(Math.random() * variants.length)]);
        }
      }
    });

    // Place user's free-text under Community & Wider Impacts if present
    if (heading === "Community & Wider Impacts:" && other) {
      lines.push("In addition, " + other.trim());
    }

    if (lines.length) {
      sectionText += `${newline}${heading}${newline}â€” ${lines.join(newline + "â€” ")}`;
    }
  }

  const subject = subjectLines[Math.floor(Math.random() * subjectLines.length)];
  const message =
    `Dear MSPs and Councillors,${newline}` +
    `My name is ${name}, and I live at ${address}, ${postcode}.${newline}` +
    `${intro}${sectionText}${newline}` +
    `${closer}${newline}` +
    `Yours sincerely,${newline}${name}`;

  try {
    const repData = await getEmailsFromPostcode(postcode);
    const emails = [];
    if (repData.msps?.length) repData.msps.forEach(m => { if (m.email) emails.push(m.email); });
    if (repData.councillors?.length) repData.councillors.forEach(c => { if (c.email) emails.push(c.email); });

    if (emails.length === 0) {
      alert("We couldnâ€™t find any email contacts for that postcode.");
      return;
    }

    const ccAddress = "thepavementtrap@gmail.com";
    const body = encodeURIComponent(message);
    const mailtoLink = `mailto:${emails.join(",")}?cc=${encodeURIComponent(ccAddress)}&subject=${encodeURIComponent(subject)}&body=${body}`;

    const a = document.createElement("a");
    a.href = mailtoLink;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    a.remove();

    setTimeout(() => {
      alert("If your email app didnâ€™t open, please check your browser settings or copy the text manually.");
    }, 800);
  } catch (e) {
    console.error(e);
    alert("Something went wrong looking up your representatives. Please double-check the postcode.");
  }
};

/* ===== Wire up events ===== */
document.getElementById("selectAll").addEventListener("click", function () {
  toggleAllIssues(this);
});
document.getElementById("openEmail").addEventListener("click", function () {
  window.generateEmail();
});

init();
</script>
</body>
</html>
