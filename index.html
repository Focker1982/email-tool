<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tell Them This Isn't Working ‚Äî Enhanced</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Open Sans', sans-serif; background-color: #f8f9fa; color: #333; max-width: 900px; margin: 40px auto; padding: 30px; border-radius: 10px; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    h1 { text-align: center; font-size: 2.2em; color: #cc0000; margin: 0; }
    .intro { background: #f0f5ff; border-left: 5px solid #003f7d; padding: 15px 20px; border-radius: 5px; margin: 25px 0; }
    label { display: block; margin: 12px 0 6px; font-weight: 600; }
    input[type="text"], textarea { width: 100%; padding: 10px; font-size: 1em; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; min-height: 44px; }
    textarea { resize: vertical; }
    input:focus, textarea:focus, button:focus { outline: 2px solid #005fa3; outline-offset: 2px; }
    .issue-list { border: 1px solid #ccc; background: #f1f1f1; padding: 15px 20px; margin-top: 20px; border-radius: 5px; }
    .issue-list label { font-weight: 600; margin: 8px 0; font-size: 1.05em; display: flex; align-items: center; }
    .issue-list input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); }
    button { margin-top: 25px; padding: 14px 24px; font-size: 1.1em; background-color: #0077cc; color: white; border: none; cursor: pointer; border-radius: 6px; transition: background-color 0.3s ease; min-height: 44px; font-family: inherit; }
    button:hover { background-color: #005fa3; }
    footer { margin-top: 40px; border-top: 1px solid #ddd; padding-top: 16px; font-size: 0.95em; color: #444; }
    @media (max-width: 600px) {
      body { padding: 20px; margin: 0 auto; }
      label { font-size: 1.05em; }
      input[type="text"], textarea { font-size: 1em; padding: 12px; }
      button { font-size: 1em; padding: 12px 20px; }
    }
  </style>
</head>
<body>
  <div style="background: linear-gradient(90deg, #0051a3, #0077cc); padding: 24px 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <h1 style="color: white;">Tell Them This Isn't Working</h1>
    <p style="color: #e0f0ff; font-size: 1.05em; margin-top: 6px;">People are the point ‚Äî not the problem.</p>
  </div>

  <div class="intro">
    <strong>Why does this tool exist?</strong><br><br>
    This tool helps you send a clear, personal email about how the pavement parking ban is playing out on <em>your</em> street. Add your details, tick the issues that apply, and we'll open a ready‚Äëto‚Äësend email to your representatives in your own voice ‚Äî practical, proportionate and evidence‚Äëled.
  </div>

  <form>
    <label for="name">Your Name:</label>
    <input type="text" id="name" placeholder="e.g. Robert Bruce" autocomplete="name" required>

    <label for="address">Your Address:</label>
    <input type="text" id="address" placeholder="e.g. 6 Charlotte Square" autocomplete="street-address" required>

    <label for="postcode">Postcode:</label>
    <input type="text" id="postcode" placeholder="e.g. EH2 4DR" autocomplete="postal-code" required>

    <div class="issue-list">
      <strong>Select the concerns that affect your street:</strong>
      <label><input type="checkbox" id="selectAll" onclick="toggleAllIssues(this)"> üîò Select all</label>
      <label><input type="checkbox" value="emergency"> üöë Emergency vehicles: tighter passing/turning space</label>
      <label><input type="checkbox" value="accessibility"> ‚ôø Accessibility: longer, harder walks for some residents</label>
      <label><input type="checkbox" value="prams"> üßí Families: prams and young children squeezed on narrow or cluttered pavements</label>
      <label><input type="checkbox" value="bins"> üöÆ Services: bin collections more difficult / delayed</label>
      <label><input type="checkbox" value="elderly"> üßì Older neighbours: distance to car becomes a barrier</label>
      <label><input type="checkbox" value="visitors"> üè† Short‚Äëstays: visitors, trades and carers struggle to stop nearby</label>
      <label><input type="checkbox" value="danger"> ‚ö† Safety and sightlines: pinch points and close calls</label>
      <label><input type="checkbox" value="blocked"> üóë Pavements blocked by council bins on collection days</label>
      <label><input type="checkbox" value="gardens"> üå± Pressure to pave front gardens / reduce greenery</label>
      <label><input type="checkbox" value="blanket"> ‚ùå One‚Äësize‚Äëfits‚Äëall enforcement where judgement is needed</label>
      <label><input type="checkbox" value="consultation"> üßæ Limited local consultation / evidence‚Äëgathering</label>
      <label><input type="checkbox" value="cohesion"> üß± Friction between neighbours as informal solutions vanish</label>
      <label><input type="checkbox" value="opposeIdeology"> üõë Set aside 20‚Äëminute city‚Äìstyle frameworks where they conflict with access</label>
      <label><input type="checkbox" value="blanket20mph"> üöó Blanket 20mph applied without local tailoring</label>
    </div>

    <label for="other">Write your own concerns:</label>
    <textarea id="other" rows="4" placeholder="Add any street‚Äëspecific evidence, examples or dates you want included‚Ä¶"></textarea>

    <button type="button" onclick="generateEmail()">Open Email</button>
  </form>

  <footer>
    <p>This tool helps you contact your MSPs and councillors about the practical effects of the pavement parking ban on your street. You can personalise the content once it opens in your email client. Every email it generates is dynamic ‚Äî the subject line, the phrasing, and the examples all change each time you use it.</p>
  </footer>

<!-- Helpers: postcode formatting -->
<script>
  function sanitizePostcode(pc) {
    return String(pc || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
  }
  function formatPostcodeForDisplay(pc) {
    const clean = sanitizePostcode(pc);
    return clean.length > 3 ? clean.slice(0, -3) + ' ' + clean.slice(-3) : clean;
  }
  function outwardFromSanitized(clean) {
    return clean.length > 3 ? clean.slice(0, -3) : clean;
  }
</script>

<!-- Updated issues bank (paragraph-friendly lines) -->
<script>
  const issues = {
    emergency: [
      "Concentrating parking on the carriageway reduces passing space and turning circles for emergency vehicles.",
      "Narrowed lanes can slow larger response vehicles at pinch points.",
      "Full on-road parking makes urgent access and manoeuvres more difficult."
    ],
    accessibility: [
      "People with reduced mobility face longer, harder walks between car and home when nearby parking disappears.",
      "Everyday tasks become more challenging for those who rely on short distances to the car.",
      "Accessibility needs are not met where alternatives are distant or impractical."
    ],
    prams: [
      "Parents with prams and young children have less room to pass comfortably on narrow or cluttered pavements.",
      "Routes feel more constrained for families where visibility and space are limited.",
      "Sharing space politely becomes harder on already tight pavements."
    ],
    bins: [
      "Waste collection is less reliable where vehicles must squeeze through reduced gaps.",
      "Limited passing space increases the chance of delays or minor damage during collections.",
      "Bin lorries and other essential services struggle where the carriageway is narrowed."
    ],
    elderly: [
      "Extra distance between car and home becomes a barrier for some older neighbours.",
      "Proximity parking helps many older residents remain independent day-to-day.",
      "Effort required for older or less mobile residents is not always considered."
    ],
    visitors: [
      "Visitors, trades and carers find it difficult to stop close by when short-stay options are limited.",
      "Routine home repairs or care visits are harder to arrange without practical local parking.",
      "Deliveries and scheduled appointments are complicated by a lack of convenient short-stay space."
    ],
    danger: [
      "Safety and visibility have not improved in practice, with tighter lanes increasing stress for drivers and pedestrians.",
      "Limited sightlines raise the chance of close calls at pinch points.",
      "Where visibility is already poor, concentrating parking on the carriageway does not feel safer."
    ],
    blocked: [
      "Council bins block pavements on collection days, reducing usable space for pedestrians.",
      "Bins left on narrow pavements make access difficult several days a week in some areas.",
      "Routine bin obstruction needs tackling alongside parking to support access aims."
    ],
    gardens: [
      "Pressure for legal parking pushes households to pave over front gardens, reducing greenery and drainage.",
      "Driveway conversions change street character and reduce biodiversity.",
      "Households feel pushed toward driveways rather than freely choosing them."
    ],
    blanket: [
      "One-size-fits-all rules leave little room for judgement based on local conditions.",
      "Residents who parked responsibly for years are caught by rigid application.",
      "Practical discretion would allow proportionate, context-sensitive enforcement."
    ],
    consultation: [
      "Engagement with residents has been limited; earlier local input would surface workable, street-level fixes.",
      "Practical evidence from people living on affected streets improves outcomes before decisions are finalised.",
      "A more open process would capture everyday impacts and local data."
    ],
    cohesion: [
      "Reduced flexibility can unintentionally create friction between neighbours where on-street space is tight.",
      "Informal arrangements that worked previously are harder to maintain.",
      "Complaints and disagreements are rising as people try to adapt."
    ],
    opposeIdeology: [
      "Please set aside 20-minute city‚Äìstyle frameworks where they conflict with accessibility for all, a functioning local transport network and the local economy. Policy should prioritise practical, locally tested measures over models."
    ],
    blanket20mph: [
      "Slower speeds help in the right places, but a universal 20mph does not always reflect real-world traffic and layouts.",
      "Targeted speed management at genuine risk points supports safety without compounding challenges from reduced parking flexibility.",
      "A context-sensitive approach to speed limits would better balance safety with everyday access."
    ]
  };
</script>

<!-- Final script: subject lines, data init, smart 'Other', narrative composer, email opener -->
<script>
  // Subject lines (calm + constructive)
  const subjectLines = [
    "Local evidence from my street ‚Äî request for practical fixes",
    "A pause and review would help our street",
    "Balancing access, safety and local life on our street",
    "Parking rules: everyday impacts and workable options",
    "Please consider context‚Äësensitive solutions for our area",
    "Improving safety and access without one‚Äësize‚Äëfits‚Äëall",
    "Constructive feedback on pavement parking changes",
    "How to make this policy work on our street",
    "Everyday impacts on residents and services ‚Äî solutions",
    "A more flexible, proportionate approach would help"
  ];

  // Init & data wiring
  async function init() {
    window.isReady = false;

    const mspData = await fetch('mspContacts.json').then(res => res.json());
    const normalize = s => s ? s.toLowerCase().replace(/[^a-z0-9]/g, '').trim() : '';
    window.normalize = normalize;

    window.apiKey = "6946df58f97fd1b9aad7493a65c4cf8cbc8ddb3b"; // MapIt key
    window._mspData = mspData;

    const normalizedRegions = {};
    Object.keys(mspData.regions).forEach(r => { normalizedRegions[normalize(r)] = mspData.regions[r]; });
    mspData.regions = normalizedRegions;

    window.mspData = mspData;
    window.isReady = true;
  }

  function toggleAllIssues(source) {
    const boxes = document.querySelectorAll(".issue-list input[type='checkbox']");
    boxes.forEach(cb => { if (cb.id !== 'selectAll') cb.checked = source.checked; });
  }

  async function getEmailsFromPostcode(postcodeInput) {
    const sanitized = sanitizePostcode(postcodeInput);
    const formatted = formatPostcodeForDisplay(postcodeInput);
    const outward = outwardFromSanitized(sanitized);

    const url = "https://mapit.mysociety.org/postcode/" + encodeURIComponent(formatted) + "?api_key=" + window.apiKey;
    const res = await fetch(url);
    if (!res.ok) throw new Error("Postcode lookup failed.");
    const data = await res.json();
    const areas = data.areas;

    let spc = null, spe = null;
    for (const area of Object.values(areas)) {
      if (area.type === "SPC") spc = area.name;
      if (area.type === "SPE") spe = area.name;
    }

    const mspKey = Object.keys(window._mspData.constituencies).find(key => window.normalize(key) === window.normalize(spc));
    const msp = mspKey ? window._mspData.constituencies[mspKey] : null;
    const regionalMSPs = window._mspData.regions[window.normalize(spe)] || [];

    const normalizedPostcode = window.normalize(formatted);
    const prefix = outward.toUpperCase();

    let councillors = [];
    const jsPath = "data/" + prefix + ".js";
    try {
      await new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = jsPath;
        script.onload = () => resolve();
        script.onerror = () => reject("Failed to load script: " + jsPath);
        document.head.appendChild(script);
      });
      councillors = window.postcodeToWardKey ? (window.postcodeToWardKey[normalizedPostcode] || []) : [];
    } catch (err) {
      console.warn(err);
    }

    return { msps: [msp, ...regionalMSPs].filter(Boolean), councillors };
  }

  // Smart "Other" text formatter
  function formatOtherText(input) {
    if (!input) return "";
    let text = input.trim();
    if (text === text.toUpperCase() && /[A-Z]/.test(text)) {
      text = text.toLowerCase();
    }
    text = text.charAt(0).toUpperCase() + text.slice(1);
    if (!/[.!?]$/.test(text)) {
      text += ".";
    }
    return text;
  }

  // Narrative composer (universal tone)
  function composeNarrative(selectedKeys, otherText) {
    function pick(key) {
      const arr = issues[key] || [];
      return arr.length ? arr[Math.floor(Math.random() * arr.length)] : null;
    }
    function collect(keys, max = 2) {
      const pool = keys.filter(k => selectedKeys.includes(k)).map(k => pick(k)).filter(Boolean);
      const unique = Array.from(new Set(pool)).slice(0, max);
      return unique.join(' ');
    }

    const gStreet   = ["emergency","danger","accessibility","prams","elderly"];
    const gService  = ["bins","visitors","blocked"];
    const gKnockOns = ["gardens"];
    const gPolicy   = ["blanket","consultation","cohesion","blanket20mph"];

    const streetImpact = collect(gStreet, 3);
    const serviceImpact = collect(gService, 2);
    const knockOns = collect(gKnockOns, 1);
    const policyRigidity = collect(gPolicy, 3);
    const ideologyLine = selectedKeys.includes("opposeIdeology") ? pick("opposeIdeology") : "";

    const paras = [];

    paras.push(
      "I am writing as a constituent to raise serious concerns about how the pavement parking ban is being applied on our street. In its current form, the policy is not consistently delivering safe, workable access for all. Pavements are not always clear or usable, and moving all parking into the carriageway does not automatically improve conditions."
    );

    if (streetImpact) {
      paras.push("On our street, concentrating parking on the carriageway has tightened space and affected everyday access and confidence. " + streetImpact);
    }

    if (serviceImpact) {
      paras.push("It has also made essential services and everyday visits more difficult. " + serviceImpact);
    }

    const formattedOther = formatOtherText(otherText);
    if (formattedOther) {
      paras.push(formattedOther);
    }

    if (knockOns) {
      paras.push("There are wider knock‚Äëon effects for the street environment. " + knockOns);
    }

    if (policyRigidity) {
      paras.push("These outcomes point to a one‚Äësize‚Äëfits‚Äëall approach that leaves little room for local circumstances, with limited opportunity for residents to share evidence before changes take effect. " + policyRigidity);
    }

    if (ideologyLine) paras.push(ideologyLine);

    paras.push(
      "I am asking you to:" +
      "\n‚Äì Pause enforcement before further disruption is caused" +
      "\n‚Äì Work across Council and Parliament to raise these concerns with ministers" +
      "\n‚Äì Support a review or amendment of the legislation so it works in practice, not just in theory" +
      "\n\nThis is not about opposing accessibility ‚Äî it is about ensuring that policies intended to improve it actually do so."
    );

    return paras.join("\n\n");
  }

  // Email generation
  window.generateEmail = async function () {
    if (!window.isReady) { alert("Still loading data. Please wait a moment and try again."); return; }

    const name = document.getElementById("name").value.trim();
    const address = document.getElementById("address").value.trim();
    const rawPostcode = document.getElementById("postcode").value.trim();
    const other = document.getElementById("other").value.trim();

    const allCheckboxes = document.querySelectorAll(".issue-list input[type='checkbox']");
    const checked = Array.from(allCheckboxes).filter(cb => cb.checked && cb.id !== 'selectAll');
    const selectedKeys = checked.map(cb => cb.value);

    const sanitized = sanitizePostcode(rawPostcode);
    const formattedPostcode = formatPostcodeForDisplay(rawPostcode);

    if (!name || !address || !sanitized) { alert("Please fill in your name, address and postcode."); return; }
    if (selectedKeys.length === 0 && !other) { alert("Please select at least one concern or add your own."); return; }

    const newline = "\n\n";
    const narrative = composeNarrative(selectedKeys, other);

    const intro = `Dear MSPs and Councillors,${newline}My name is ${name}, and I live at ${address}, ${formattedPostcode}.`;
    const message = `${intro}${newline}${narrative}${newline}Regards,${newline}${name}`;

    const subject = subjectLines[Math.floor(Math.random() * subjectLines.length)];

    try {
      const repData = await getEmailsFromPostcode(rawPostcode);
      const emails = [];
      if (repData.msps && repData.msps.length) repData.msps.forEach(m => { if (m.email) emails.push(m.email); });
      if (repData.councillors && repData.councillors.length) repData.councillors.forEach(c => { if (c.email) emails.push(c.email); });

      if (emails.length === 0) { alert("We couldn't find any email contacts for that postcode."); return; }

      const ccAddress = "thepavementtrap@gmail.com";
      const body = message.replace(/\n/g, "%0D%0A");
      const mailtoLink = "mailto:" + emails.join(",") + "?cc=" + encodeURIComponent(ccAddress) + "&subject=" + encodeURIComponent(subject) + "&body=" + body;

      const tempLink = document.createElement("a");
      tempLink.href = mailtoLink; tempLink.style.display = "none"; document.body.appendChild(tempLink);
      tempLink.click(); document.body.removeChild(tempLink);

      setTimeout(function(){ alert("If your email app did not open, please check your browser settings or copy the text manually."); }, 1000);
    } catch (e) {
      console.error("Error fetching representatives:", e);
      alert("Something went wrong looking up your representatives. Please double‚Äëcheck the postcode.");
    }
  };

  // Select‚Äëall toggle
  document.getElementById("selectAll").addEventListener("click", function () {
    const isChecked = this.checked;
    const boxes = document.querySelectorAll(".issue-list input[type='checkbox']");
    boxes.forEach(cb => { if (cb.id !== "selectAll") cb.checked = isChecked; });
  });

  // Postcode field behaviour
  const pcInput = document.getElementById("postcode");
  pcInput.addEventListener("input", function(){ pcInput.value = pcInput.value.toUpperCase(); });
  pcInput.addEventListener("blur", function(){ pcInput.value = formatPostcodeForDisplay(pcInput.value); });

  init();
</script>
</body>
</html>
