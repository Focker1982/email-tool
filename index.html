<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tell Them This Isnâ€™t Working</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: white; /* header back to white */
      margin: 0;
    }
    .hero {
      background: linear-gradient(90deg, #0051a3, #0077cc);
      padding: 30px 20px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .hero p {
      color: #e0f0ff;
      font-size: 1.05em;
      margin-top: 8px;
    }
    .intro {
      background: #f0f5ff;
      padding: 15px 20px;
      border-left: 5px solid #003f7d;
      border-radius: 5px;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: inherit;
      min-height: 44px;
    }
    textarea { resize: vertical; }
    input:focus, textarea:focus, button:focus {
      outline: 2px solid #005fa3;
      outline-offset: 2px;
    }
    .issue-list {
      border: 1px solid #ccc;
      background: #f7f7f7;
      padding: 15px 20px;
      margin-top: 20px;
      border-radius: 5px;
    }
    .issue-list label {
      font-weight: 600;
      margin: 8px 0;
      font-size: 1.05em;
      display: flex;
      align-items: center;
    }
    .issue-list input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    button {
      margin-top: 25px;
      padding: 14px 24px;
      font-size: 1.1em;
      background-color: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      transition: background-color 0.3s ease;
      min-height: 44px;
      font-family: inherit;
    }
    button:hover { background-color: #005fa3; }
    footer {
      margin-top: 40px;
      border-top: 1px solid #ddd;
      padding-top: 18px;
      font-size: 0.95em;
      color: #444;
    }
    @media (max-width: 600px) {
      body { padding: 20px; }
      input[type="text"], textarea { font-size: 1em; padding: 12px; }
      button { font-size: 1em; padding: 12px 20px; }
    }
  </style>
</head>
<body>
  <div class="hero">
    <h1>Tell Them This Isnâ€™t Working</h1>
    <p>Real Voices. Real Streets. Real Problems.</p>
  </div>

  <div class="intro">
    <strong>Why does this tool exist?</strong><br><br>
    This tool makes it easy to add your voice â€” without having to write from scratch. Every message is unique, personal, and harder for MSPs and councillors to dismiss as copyâ€‘andâ€‘paste.
  </div>

  <form>
    <label for="name">Your Name:</label>
    <input type="text" id="name" placeholder="e.g. Jane Smith" autocomplete="name" required>

    <label for="address">Your Address:</label>
    <input type="text" id="address" placeholder="e.g. 6 Charlotte Square" autocomplete="street-address" required>

    <label for="postcode">Postcode:</label>
    <input type="text" id="postcode" placeholder="e.g. EH2 4DR" autocomplete="postal-code" required>

    <div class="issue-list">
      <strong>Select the concerns that affect your street:</strong>
      <label><input type="checkbox" id="selectAll"> ğŸ”˜ Select all</label>

      <label><input type="checkbox" value="emergency"> ğŸš‘ Emergency vehicles could be blocked</label>
      <label><input type="checkbox" value="danger"> âš ï¸ Danger now worse than before</label>

      <label><input type="checkbox" value="accessibility"> â™¿ï¸ Accessibility needs not considered</label>
      <label><input type="checkbox" value="prams"> ğŸ§’ Children and prams forced into road space</label>
      <label><input type="checkbox" value="elderly"> ğŸ§“ Elderly residents struggling with distance</label>
      <label><input type="checkbox" value="visitors"> ğŸ  Family, friends, trades canâ€™t stop nearby</label>
      <label><input type="checkbox" value="bins"> ğŸš® Bin collections missed or disrupted</label>
      <label><input type="checkbox" value="blocked"> ğŸ—‘ï¸ Pavements blocked by council bins</label>

      <label><input type="checkbox" value="gardens"> ğŸŒ± More paving over gardens</label>
      <label><input type="checkbox" value="blanket"> âŒ Oneâ€‘sizeâ€‘fitsâ€‘all enforcement</label>
      <label><input type="checkbox" value="consultation"> ğŸ§¾ Limited consultation</label>
      <label><input type="checkbox" value="cohesion"> ğŸ§± Social cohesion under strain</label>

      <label><input type="checkbox" value="opposeIdeology"> ğŸ›‘ Reject 20â€‘minute cityâ€“style frameworks</label>
      <label><input type="checkbox" value="blanket20mph"> ğŸš— Reject blanket 20â€¯mph</label>
    </div>

    <label for="other">Write your own concerns:</label>
    <textarea id="other" rows="4" placeholder="Add anything specific to your street..."></textarea>

    <button type="button" onclick="generateEmail()">Open Email</button>
  </form>

  <footer>
    <p>This launches an email to your MSPs and councillors with your selected points. You can still edit it before sending.</p>
  </footer>

<script>
/* ===== Issue variants (kept long and specific) ===== */
var issues = {
  emergency: [
    "Forcing all cars onto the road removes passing and turning space when seconds matter for blueâ€‘light access.",
    "Once parking fills the carriageway, fire and ambulance vehicles struggle at pinch points and response times can slip.",
    "Critical space and turning circles are lost when the road is narrowed by displaced parking â€” thatâ€™s an emergency access risk."
  ],
  danger: [
    "This policy hasnâ€™t made our street safer. Itâ€™s created narrower lanes, reduced escape space for pedestrians, and made passing or reversing more dangerous than before.",
    "By forcing all parking onto the road, the policy increases the chance of collisions and close calls â€” particularly where visibility is already limited.",
    "Narrower lanes and tighter gaps are increasing driver stress and nearâ€‘misses, not reducing them."
  ],
  accessibility: [
    "This policy creates unfair barriers for anyone with reduced mobility. There are no practical nearby alternatives for those who canâ€™t easily walk longer distances, and the result is a less accessible environment â€” not a more inclusive one.",
    "Those with walking aids, temporary injuries, or pushchairs now face longer, more difficult routes between car and door â€” often with no safe option.",
    "Removing proximity parking creates a bigger barrier for anyone who canâ€™t manage distance or uneven routes."
  ],
  prams: [
    "On streets where pavements are already obstructed or uneven, full onâ€‘road parking forces prams and young children into the carriageway, making every journey riskier.",
    "Families who used to share space carefully now find less road width and no safe workaround once all parking is pushed onâ€‘road.",
    "Rather than protecting families, this policy pushes children and prams into live traffic where partial kerb parking once gave them a buffer."
  ],
  elderly: [
    "For older residents, having to walk further with shopping or mobility issues is a serious challenge; removing nearby parking undermines independence.",
    "That extra distance isnâ€™t just inconvenient â€” itâ€™s a real barrier for older people managing dayâ€‘toâ€‘day tasks.",
    "Even a short walk can be daunting with limited mobility; removing proximity parking doesnâ€™t feel like progress."
  ],
  visitors: [
    "When family, friends, trades or local businesses canâ€™t park nearby, everyday life suffers â€” from childcare and school runs to helping an older relative.",
    "Restricting shortâ€‘stay parking makes it harder for families to connect, friends to visit, and local services to deliver â€” it chips away at community life.",
    "Losing the ability to stop close to someoneâ€™s home undermines everyday support networks â€” grandparents helping with children, friends checking in, and local businesses or trades providing essential services."
  ],
  bins: [
    "The current layout makes waste collection harder: large vehicles must squeeze through narrow gaps or mount the kerb, increasing delays and minor damage.",
    "Bin lorries struggle when streets are fully occupied by onâ€‘road parking; incidental damage and missed collections become more likely.",
    "Itâ€™s obvious this layout puts bin collection at risk. Narrowed roads and awkward angles force council vehicles into difficult positions â€” often onto pavements to get past."
  ],
  blocked: [
    "Pavements can be impassable due to council bin storage, but residents are penalised for adapting to keep the street workable.",
    "Weâ€™re banned from using the pavement to keep the road clear, yet council bins regularly block pavements â€” and all that space is now lost on the road as well.",
    "It makes no sense to ban partial pavement use while council bins routinely block them; the result is less space on both pavement and road."
  ],
  gardens: [
    "The pressure to find legal parking is leading residents to pave over front gardens, harming drainage, biodiversity and the character of the street.",
    "More hardstanding means worse drainage, less greenery, and a less welcoming street scene â€” an avoidable sideâ€‘effect of inflexible rules.",
    "Driveway conversions are becoming more common, not because residents want them, but because they feel forced â€” leaving harder, less green streets and higher flood risk."
  ],
  blanket: [
    "A universal ban treats all situations the same, regardless of context. We need flexibility and discretion â€” not oneâ€‘sizeâ€‘fitsâ€‘all enforcement.",
    "Applying the same rule to every street â€” whatever its layout or history â€” isnâ€™t sensible enforcement.",
    "Parking that worked safely for years is being criminalised; enforcement should focus on real obstructions, not routine, practical parking."
  ],
  consultation: [
    "This was introduced without meaningful streetâ€‘level consultation; those directly affected were left out.",
    "Major change should include local voices and evidence before rollout.",
    "Residents werenâ€™t asked how this would impact them â€” they were told after the fact."
  ],
  cohesion: [
    "Strict rules on scarce space strain community goodwill and cooperation.",
    "Removing informal arrangements over limited space creates avoidable disputes.",
    "Community cohesion is easier to maintain when local solutions are supported alongside policy."
  ],
  opposeIdeology: [
    "I do not support the application of 20â€‘minute cityâ€“style planning where it restricts everyday access; it should be removed from transport policy.",
    "20â€‘minute city frameworks should not shape streetâ€‘level parking or access; they donâ€™t reflect residentsâ€™ needs in practice.",
    "I reject the use of 20â€‘minute city principles in access planning; where applied, they should be withdrawn in favour of practical, streetâ€‘tested solutions."
  ],
  blanket20mph: [
    "I do not support a universal 20â€¯mph limit; it should be reversed in favour of targeted limits where genuinely needed.",
    "Blanket 20â€¯mph zones should be replaced by speed management based on actual local risk.",
    "Retaining existing limits with targeted interventions would be more proportionate than a universal 20â€¯mph."
  ]
};

/* ===== Subject lines ===== */
var subjectLines = [
  "Request for review of pavement parking policy",
  "Pause and review to improve street access",
  "Local impacts and needed adjustments to parking rules",
  "Evidence from residents on pavement parking changes",
  "Making parking rules work for all users",
  "Balancing safety and access on local streets",
  "Call for practical review of parking restrictions",
  "How to deliver safer, more accessible streets",
  "Concerns about current pavement parking approach",
  "Improving policy outcomes through local review",
  "Ensuring parking policy matches real street conditions",
  "Working together to fix unintended impacts",
  "Practical solutions for safer local streets"
];

/* ===== Dynamic bridges & openers ===== */
var openers = [
  "Pushing every car fully onto the road narrows lanes and removes turning space. Thatâ€™s not safer, and itâ€™s not more accessible.",
  "Moving all parking onto the carriageway creates tighter conditions without a clear gain in accessibility.",
  "Concentrating parking on the road removes the buffer partialâ€‘kerb parking provided â€” with little improvement to pavement usability."
];

var generalLeadIns = [
  "The following points reflect what this change means in real terms on our street:",
  "Hereâ€™s how this is playing out dayâ€‘toâ€‘day where we live:",
  "In practice, residents are experiencing the impacts below:"
];

var sectionLeadIns = {
  safety: [
    "On safety and emergency access:",
    "For emergency access and general safety:"
  ],
  mobility: [
    "On everyday access and mobility:",
    "For dayâ€‘toâ€‘day journeys and access:"
  ],
  community: [
    "Wider knockâ€‘on effects in the community:",
    "Beyond individual journeys, the wider impacts include:"
  ],
  policy: [
    "At a policy level:",
    "Wider policy concerns:"
  ]
};

/* ===== Category mapping ===== */
var categories = {
  safety: ["emergency","danger"],
  mobility: ["accessibility","prams","elderly","visitors","bins","blocked"],
  community: ["gardens","blanket","consultation","cohesion"],
  policy: ["opposeIdeology","blanket20mph"]
};

/* ===== Utils ===== */
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }

function toggleAllIssues(source) {
  const boxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  boxes.forEach(cb => { if (cb.id !== 'selectAll') cb.checked = source.checked; });
}

/* ===== MSP/Councillor lookup ===== */
async function init() {
  window.isReady = false;

  const mspData = await fetch('mspContacts.json').then(res => res.json());
  const normalize = str => str?.toLowerCase().replace(/[^a-z0-9]/g, '').trim();
  window.normalize = normalize;

  window.apiKey = "6946df58f97fd1b9aad7493a65c4cf8cbc8ddb3b";
  window._mspData = mspData;

  const normalizedRegions = {};
  Object.keys(mspData.regions).forEach(regionName => {
    normalizedRegions[normalize(regionName)] = mspData.regions[regionName];
  });
  mspData.regions = normalizedRegions;

  window.mspData = mspData;
  window.isReady = true;
}

async function getEmailsFromPostcode(postcode) {
  const url = `https://mapit.mysociety.org/postcode/${encodeURIComponent(postcode)}?api_key=${window.apiKey}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Postcode lookup failed.");
  const data = await res.json();
  const areas = data.areas;

  let spc = null, spe = null;
  for (const area of Object.values(areas)) {
    if (area.type === "SPC") spc = area.name;
    if (area.type === "SPE") spe = area.name;
  }

  const mspKey = Object.keys(window._mspData.constituencies)
    .find(key => window.normalize(key) === window.normalize(spc));
  const msp = mspKey ? window._mspData.constituencies[mspKey] : null;
  const regionalMSPs = window._mspData.regions[window.normalize(spe)] || [];

  const normalizedPostcode = window.normalize(postcode);
  const postcodePrefix = postcode.trim().toUpperCase().split(' ')[0];
  let councillors = [];
  const jsPath = `data/${postcodePrefix}.js`;
  try {
    await new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src = jsPath;
      script.onload = () => resolve();
      script.onerror = () => reject(`Failed to load script: ${jsPath}`);
      document.head.appendChild(script);
    });
    councillors = window.postcodeToWardKey?.[normalizedPostcode] || [];
  } catch (err) {
    console.warn(err);
  }
  return { msps: [msp, ...regionalMSPs].filter(Boolean), councillors };
}

/* ===== Email builder ===== */
window.generateEmail = async function () {
  if (!window.isReady) {
    alert("Still loading data. Please wait a moment and try again.");
    return;
  }

  const name = document.getElementById("name").value.trim();
  const address = document.getElementById("address").value.trim();
  const postcode = document.getElementById("postcode").value.trim();
  const other = document.getElementById("other").value.trim();

  const allCheckboxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  const selected = Array.from(allCheckboxes)
    .filter(cb => cb.checked && cb.id !== 'selectAll')
    .map(cb => cb.value);

  if (!name || !address || !postcode) {
    alert("Please fill in your name, address, and postcode.");
    return;
  }
  if (selected.length === 0 && !other) {
    alert("Please select at least one concern or add your own.");
    return;
  }

  const nl = '\n\n';
  const greet = "Dear MSPs and Councillors,";
  const intro = `My name is ${name}, and I live at ${address}, ${postcode}.`;
  const opener = pick(openers);
  const general = pick(generalLeadIns);

  // Build category -> bullet lines (one variant per selected issue)
  function pickLines(keys) {
    const out = [];
    keys.forEach(k => {
      if (selected.includes(k) && issues[k]?.length) {
        out.push("â€” " + pick(issues[k]));
      }
    });
    return out;
  }

  const safetyLines = pickLines(categories.safety);
  const mobilityLines = pickLines(categories.mobility);
  const communityLines = pickLines(categories.community);
  const policyLines = pickLines(categories.policy);

  // Compose body with bridges so sparse selections still flow
  let body = `${greet}${nl}${intro}${nl}${opener}${nl}${general}${nl}`;

  if (safetyLines.length) {
    body += sectionLeadIns.safety ? pick(sectionLeadIns.safety) + nl : "";
    body += safetyLines.join('\n') + nl;
  }
  if (mobilityLines.length) {
    body += nl + (sectionLeadIns.mobility ? pick(sectionLeadIns.mobility) + nl : "");
    body += mobilityLines.join('\n') + nl;
  }
  if (communityLines.length) {
    body += nl + (sectionLeadIns.community ? pick(sectionLeadIns.community) + nl : "");
    body += communityLines.join('\n') + nl;
  }
  if (policyLines.length) {
    body += nl + (sectionLeadIns.policy ? pick(sectionLeadIns.policy) + nl : "");
    body += policyLines.join('\n') + nl;
  }

  // Add user's own note if present
  if (other) {
    body += nl + "Other:" + nl + "â€” In addition, " + other.trim() + nl;
  }

  const closer = "Please act now: pause enforcement where it causes more harm than good, gather streetâ€‘level evidence, and make the necessary local and national changes so the policy delivers safety and accessibility in reality â€” not just on paper.";
  const signOff = `Yours sincerely,${nl}${name}`;

  const message = body + nl + closer + nl + nl + signOff;
  const subject = pick(subjectLines);

  try {
    const repData = await getEmailsFromPostcode(postcode);
    const emails = [];
    if (repData.msps?.length) repData.msps.forEach(m => { if (m.email) emails.push(m.email); });
    if (repData.councillors?.length) repData.councillors.forEach(c => { if (c.email) emails.push(c.email); });

    if (emails.length === 0) {
      alert("We couldnâ€™t find any email contacts for that postcode.");
      return;
    }

    const ccAddress = "thepavementtrap@gmail.com";
    const bodyParam = message.replace(/\n/g, '%0D%0A');
    const mailtoLink = `mailto:${emails.join(",")}?cc=${encodeURIComponent(ccAddress)}&subject=${encodeURIComponent(subject)}&body=${bodyParam}`;

    const a = document.createElement("a");
    a.href = mailtoLink;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  } catch (error) {
    console.error("Error fetching representatives:", error);
    alert("Something went wrong looking up your representatives. Please double-check the postcode.");
  }
};

/* ===== Select all listener ===== */
document.getElementById("selectAll").addEventListener("click", function () {
  toggleAllIssues(this);
});

/* Init on load */
init();
</script>
</body>
</html>
