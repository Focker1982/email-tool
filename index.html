<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tell Them This Isn’t Working</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: white;
      margin: 0;
    }
    .hero {
      background: linear-gradient(90deg, #0051a3, #0077cc);
      padding: 30px 20px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .hero p { color: #e0f0ff; font-size: 1.05em; margin: 8px 0 0; }
    .intro {
      background: #f0f5ff;
      padding: 16px 18px;
      border-left: 5px solid #003f7d;
      border-radius: 5px;
      margin-bottom: 18px;
      line-height: 1.4;
    }
    label {
      display: block;
      margin: 10px 0 6px;
      font-weight: 600;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: inherit;
      min-height: 44px;
    }
    textarea { resize: vertical; }
    input:focus, textarea:focus, button:focus {
      outline: 2px solid #005fa3;
      outline-offset: 2px;
    }
    .issue-list {
      border: 1px solid #ccc;
      background: #f7f7f7;
      padding: 14px 18px;
      margin-top: 14px;
      border-radius: 5px;
    }
    .issue-list label {
      font-weight: 600;
      margin: 6px 0;
      font-size: 1.05em;
      display: flex;
      align-items: center;
    }
    .issue-list input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    button {
      margin-top: 18px;
      padding: 12px 22px;
      font-size: 1.06em;
      background-color: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      transition: background-color 0.3s ease;
      min-height: 44px;
      font-family: inherit;
    }
    button:hover { background-color: #005fa3; }
    footer {
      margin-top: 28px;
      border-top: 1px solid #ddd;
      padding-top: 14px;
      font-size: 0.95em;
      color: #444;
      line-height: 1.45;
    }
    @media (max-width: 600px) {
      body { padding: 20px; }
      input[type="text"], textarea { font-size: 1em; padding: 12px; }
      button { font-size: 1em; padding: 12px 20px; }
    }
  </style>
</head>
<body>
  <div class="hero">
    <h1>Tell Them This Isn’t Working</h1>
    <p>Real Voices. Real Streets. Real Problems.</p>
  </div>

  <div class="intro">
    <strong>Why this exists</strong><br>
    Create a clear, personal email in seconds. Each send varies the phrasing so it isn’t dismissed as copy‑and‑paste.
  </div>

  <form>
    <label for="name">Your Name:</label>
    <input type="text" id="name" placeholder="e.g. Jane Smith" autocomplete="name" required>

    <label for="address">Your Address:</label>
    <input type="text" id="address" placeholder="e.g. 6 Charlotte Square" autocomplete="street-address" required>

    <label for="postcode">Postcode:</label>
    <input type="text" id="postcode" placeholder="e.g. EH2 4DR" autocomplete="postal-code" required>

    <div class="issue-list">
      <strong>Select the concerns that affect your street:</strong>
      <label><input type="checkbox" id="selectAll"> 🔘 Select all</label>

      <label><input type="checkbox" value="emergency"> 🚑 Emergency vehicles could be blocked</label>
      <label><input type="checkbox" value="danger"> ⚠️ Danger now worse than before</label>

      <label><input type="checkbox" value="accessibility"> ♿️ Accessibility needs not considered</label>
      <label><input type="checkbox" value="prams"> 🧒 Children and prams forced into road space</label>
      <label><input type="checkbox" value="elderly"> 🧓 Elderly residents struggling with distance</label>
      <label><input type="checkbox" value="visitors"> 🏠 Family, friends, trades can’t stop nearby</label>
      <label><input type="checkbox" value="bins"> 🚮 Bin collections missed or disrupted</label>
      <label><input type="checkbox" value="blocked"> 🗑️ Pavements blocked by council bins</label>

      <label><input type="checkbox" value="gardens"> 🌱 More paving over gardens</label>
      <label><input type="checkbox" value="blanket"> ❌ One‑size‑fits‑all enforcement</label>
      <label><input type="checkbox" value="consultation"> 🧾 Limited consultation</label>
      <label><input type="checkbox" value="cohesion"> 🧱 Social cohesion under strain</label>

      <label><input type="checkbox" value="opposeIdeology"> 🛑 Reject 20‑minute city–style frameworks</label>
      <label><input type="checkbox" value="blanket20mph"> 🚗 Reject blanket 20 mph</label>
    </div>

    <label for="other">Write your own concerns:</label>
    <textarea id="other" rows="4" placeholder="Add anything specific to your street..."></textarea>

    <button type="button" onclick="generateEmail()">Open Email</button>
  </form>

  <footer>
    <p>This launches an email to your MSPs and councillors with your selected points. You can edit it before sending.</p>
  </footer>

<script>
/* ===== Issue variants (long, tuned; kerb -> pavement) ===== */
var issues = {
  emergency: [
    "Forcing all cars onto the road removes passing and turning space when seconds matter for emergency access.",
    "Once parking fills the carriageway, fire and ambulance vehicles struggle at pinch points and response times can slip.",
    "Critical space and turning circles are lost when the road is narrowed by displaced parking — that’s an emergency access risk."
  ],
  danger: [
    "This policy hasn’t made our street safer. It’s created narrower lanes, reduced escape space for pedestrians, and made passing or reversing more dangerous than before.",
    "Visibility is worse and space is tighter; what used to be a calm residential route now feels more stressful for drivers and pedestrians alike.",
    "By forcing all parking onto the road, the policy increases the chance of collisions and close calls — particularly where visibility is already limited. That’s not what safer streets look like."
  ],
  accessibility: [
    "Many residents, including the elderly and those recovering from injury, rely on being able to park near their homes. With limited legal alternatives, the ban makes daily life more difficult for people who already face mobility challenges.",
    "This policy creates unfair barriers for anyone with reduced mobility. There are no practical nearby alternatives for those who can’t easily walk longer distances, and the result is a less accessible environment — not a more inclusive one.",
    "Those with walking aids, temporary injuries, or pushchairs now face longer, more difficult routes between car and door — often with no safe option."
  ],
  prams: [
    "On streets where pavements are already obstructed or uneven, full on‑road parking forces prams and young children to share a now narrowed carriageway, making every journey riskier.",
    "Families used to navigate safely with prams or young kids becuase space was shared carefully. Now, full on road parking leaves less road space and less visibility for the real use of the street.",
    "Rather than protecting families, this policy pushes children and prams into live traffic where pavements are already obstructed or uneven. Partial pavement parking provided room for practical use."
  ],
  elderly: [
    "For older residents, having to walk further with shopping or mobility issues is a serious challenge; removing nearby parking undermines independence.",
    "That extra distance isn’t just inconvenient — it’s a real barrier for older people managing day‑to‑day tasks.",
    "Even a short walk can be daunting with limited mobility; removing proximity parking doesn’t feel like progress."
  ],
  visitors: [
    "When family, friends, trades or local businesses can’t park nearby, everyday life suffers — from childcare and school runs to helping an older relative.",
    "Restricting short‑stay parking makes it harder for families to connect, friends to visit, and local services to deliver — it chips away at the fabric of community.",
    "Losing the ability to stop close to someone’s home undermines everyday support networks — grandparents helping with children, friends checking in, and local businesses or trades providing essential services."
  ],
  bins: [
    "The current layout makes waste collection harder: large vehicles must squeeze through narrow gaps or mount the kerb, increasing delays and minor damage.",
    "Narrowed roads and awkward angles force council vehicles into difficult positions — often onto pavements to get past.",
    "Bin lorries will have more difficulty accessing streets fully occupied by on‑road parking, and damage to parked cars becomes more likely as a result."
  ],
  blocked: [
    "Pavements can be impassable due to council bin storage, but residents are penalised for adapting to keep the street workable.",
    "We’re banned from using the pavement to keep the road clear, yet council bins regularly block pavements — and all that space is now lost on the road as well.",
    "It makes no sense to ban partial pavement use while council bins routinely block them; the result is less space on both pavement and road."
  ],
  gardens: [
    "Driveway conversions are becoming more common, not because residents want them, but because they feel forced — leaving harder, less green streets and higher flood risk.",
    "The pressure to find legal parking is leading residents to pave over front gardens, harming drainage, biodiversity and the character of the street.",
    "More hardstanding means worse drainage, less greenery, and a less welcoming street scene — an avoidable side‑effect of inflexible rules."
  ],
  blanket: [
    "A universal ban treats all situations the same, regardless of context. We need flexibility and discretion — not one‑size‑fits‑all enforcement.",
    "Applying the same rule to every street — whatever its layout or history — isn’t sensible enforcement.",
    "Parking that worked safely for years is being criminalised; enforcement should focus on real obstructions, not routine, practical parking."
  ],
  consultation: [
    "This was introduced without meaningful street‑level consultation; those directly affected were left out.",
    "Major change should include local voices and evidence before rollout.",
    "Residents weren’t asked how this would impact them — they were told after the fact."
  ],
  cohesion: [
    "Strict rules on scarce space strain community goodwill and cooperation.",
    "Removing informal arrangements over limited space creates avoidable disputes.",
    "Community cohesion is easier to maintain when local solutions are supported alongside policy."
  ],
  opposeIdeology: [
    "I do not support the application of 20‑minute city–style planning where it restricts everyday access; it should be removed from transport policy.",
    "20‑minute city frameworks should not shape street‑level parking or access; they don’t reflect residents’ needs in practice.",
    "I reject the use of 20‑minute city principles in access planning; where applied, they should be withdrawn in favour of practical, street‑tested solutions."
  ],
  blanket20mph: [
    "I do not support a universal 20 mph limit; it should be reversed in favour of targeted limits where genuinely needed.",
    "Blanket 20 mph zones should be replaced by speed management based on actual local risk.",
    "Retaining existing limits with targeted interventions would be more proportionate than a universal 20 mph."
  ]
};

/* ===== Subjects, openers, bridges, dynamic closers ===== */
var subjectLines = [
  "Request for review of pavement parking policy",
  "Pause and review to improve street access",
  "Local impacts and needed adjustments to parking rules",
  "Evidence from residents on pavement parking changes",
  "Making parking rules work for all users",
  "Balancing safety and access on local streets",
  "Call for practical review of parking restrictions",
  "How to deliver safer, more accessible streets",
  "Concerns about current pavement parking approach",
  "Improving policy outcomes through local review",
  "Ensuring parking policy matches real street conditions",
  "Working together to fix unintended impacts",
  "Practical solutions for safer local streets"
];

var openers = [
  "Concentrating parking on the road removes the buffer partial‑pavement parking provided — with little improvement to actual pavement usability.",
  "Pushing every car fully onto the road narrows lanes and removes turning space — without a clear gain in pavement access.",
  "Moving all parking onto the carriageway creates tighter conditions while pavement usability remains largely unchanged."
];

var balanceBridges = [
  "Residents have adapted over the years to keep streets workable for everyone, but this change risks undoing that balance — replacing workable compromises with new obstacles.",
  "For years, people made our street function with common‑sense compromises; the new setup upends that without solving the real access problems.",
  "Local routines evolved to make things work; this shift disrupts them and introduces new risks."
];

var generalLeadIns = [
  "Here’s how this is playing out day‑to‑day where we live:",
  "In practice, residents are experiencing the impacts below:",
  "These are the real‑world effects we’re seeing:"
];

var dynamicClosers = [
  "Please act now: pause enforcement where it causes more harm than good, gather street‑level evidence, and make the local and national changes needed so the policy delivers safety and accessibility in reality — not just on paper.",
  "I’m asking you to pause enforcement in problem areas, engage directly with residents and essential services, and adjust both guidance and law so streets are safe and genuinely accessible in practice.",
  "A short pause, a rapid, evidence‑led review, and targeted amendments to exemptions and enforcement would let councils deliver safety and access without avoidable harm to residents or services.",
  "Please halt enforcement where it reduces access or increases risk, co‑design fixes with affected streets, and press Ministers to amend the framework so it fits real‑world conditions.",
  "I’m asking for a pragmatic reset: pause, review with data from our streets, and update exemptions/enforcement so the outcomes match the intention — safer, more accessible streets."
];

var sectionLeadIns = {
  safety: [
    "For emergency access and general safety:",
    "On safety and emergency access:"
  ],
  mobility: [
    "On everyday access and mobility:",
    "For day‑to‑day journeys and access:"
  ],
  community: [
    "Beyond individual journeys, the wider impacts include:",
    "Wider knock‑on effects in the community:"
  ],
  policy: [
    "At a policy level:",
    "Wider policy concerns:"
  ]
};

/* ===== Category mapping ===== */
var categories = {
  safety: ["emergency","danger"],
  mobility: ["accessibility","prams","elderly","visitors","bins","blocked"],
  community: ["gardens","blanket","consultation","cohesion"],
  policy: ["opposeIdeology","blanket20mph"]
};

/* ===== Utils ===== */
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }

function toggleAllIssues(source) {
  const boxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  boxes.forEach(cb => { if (cb.id !== 'selectAll') cb.checked = source.checked; });
}

/* ===== MSP/Councillor lookup ===== */
async function init() {
  window.isReady = false;

  const mspData = await fetch('mspContacts.json').then(res => res.json());
  const normalize = str => str?.toLowerCase().replace(/[^a-z0-9]/g, '').trim();
  window.normalize = normalize;

  window.apiKey = "6946df58f97fd1b9aad7493a65c4cf8cbc8ddb3b";
  window._mspData = mspData;

  const normalizedRegions = {};
  Object.keys(mspData.regions).forEach(regionName => {
    normalizedRegions[normalize(regionName)] = mspData.regions[regionName];
  });
  mspData.regions = normalizedRegions;

  window.mspData = mspData;
  window.isReady = true;
}

async function getEmailsFromPostcode(postcode) {
  const url = `https://mapit.mysociety.org/postcode/${encodeURIComponent(postcode)}?api_key=${window.apiKey}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Postcode lookup failed.");
  const data = await res.json();
  const areas = data.areas;

  let spc = null, spe = null;
  for (const area of Object.values(areas)) {
    if (area.type === "SPC") spc = area.name;
    if (area.type === "SPE") spe = area.name;
  }

  const mspKey = Object.keys(window._mspData.constituencies)
    .find(key => window.normalize(key) === window.normalize(spc));
  const msp = mspKey ? window._mspData.constituencies[mspKey] : null;
  const regionalMSPs = window._mspData.regions[window.normalize(spe)] || [];

  const normalizedPostcode = window.normalize(postcode);
  const postcodePrefix = postcode.trim().toUpperCase().split(' ')[0];
  let councillors = [];
  const jsPath = `data/${postcodePrefix}.js`;
  try {
    await new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src = jsPath;
      script.onload = () => resolve();
      script.onerror = () => reject(`Failed to load script: ${jsPath}`);
      document.head.appendChild(script);
    });
    councillors = window.postcodeToWardKey?.[normalizedPostcode] || [];
  } catch (err) {
    console.warn(err);
  }
  return { msps: [msp, ...regionalMSPs].filter(Boolean), councillors };
}

/* ===== Email builder (tighter spacing + dynamic bridge/closer) ===== */
window.generateEmail = async function () {
  if (!window.isReady) {
    alert("Still loading data. Please wait a moment and try again.");
    return;
  }

  const name = document.getElementById("name").value.trim();
  const address = document.getElementById("address").value.trim();
  const postcode = document.getElementById("postcode").value.trim();
  const other = document.getElementById("other").value.trim();

  const allCheckboxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  const selected = Array.from(allCheckboxes)
    .filter(cb => cb.checked && cb.id !== 'selectAll')
    .map(cb => cb.value);

  if (!name || !address || !postcode) {
    alert("Please fill in your name, address, and postcode.");
    return;
  }
  if (selected.length === 0 && !other) {
    alert("Please select at least one concern or add your own.");
    return;
  }

  const nl = '\n';
  const dbl = '\n\n';
  const greet = "Dear MSPs and Councillors,";
  const intro = `My name is ${name}, and I live at ${address}, ${postcode}.`;
  const opener = pick(openers);
  const balance = pick(balanceBridges);     // dynamic balance bridge
  const general = pick(generalLeadIns);

  function pickLines(keys) {
    const out = [];
    keys.forEach(k => {
      if (selected.includes(k) && issues[k]?.length) {
        out.push("— " + pick(issues[k]));
      }
    });
    return out;
  }

  const safetyLines = pickLines(categories.safety);
  const mobilityLines = pickLines(categories.mobility);
  const communityLines = pickLines(categories.community);
  const policyLines = pickLines(categories.policy);

  let body = [
    greet, '',
    intro,
    opener,
    balance,
    general
  ].join(nl) + dbl;

  function addSection(leadIns, lines) {
    if (!lines.length) return '';
    return pick(leadIns) + nl + lines.join(nl) + dbl;
  }

  body += addSection(sectionLeadIns.safety, safetyLines);
  body += addSection(sectionLeadIns.mobility, mobilityLines);
  body += addSection(sectionLeadIns.community, communityLines);
  body += addSection(sectionLeadIns.policy, policyLines);

  if (other) {
    body += "Other:" + nl + "— In addition, " + other.trim() + dbl;
  }

  const closer = pick(dynamicClosers);      // dynamic closer
  const signOff = `Yours sincerely,${nl}${name}`;

  const message = body + closer + dbl + signOff;
  const subject = pick(subjectLines);

  try {
    const repData = await getEmailsFromPostcode(postcode);
    const emails = [];
    if (repData.msps?.length) repData.msps.forEach(m => { if (m.email) emails.push(m.email); });
    if (repData.councillors?.length) repData.councillors.forEach(c => { if (c.email) emails.push(c.email); });

    if (emails.length === 0) {
      alert("We couldn’t find any email contacts for that postcode.");
      return;
    }

    const ccAddress = "thepavementtrap@gmail.com";
    const bodyParam = message.replace(/\n/g, '%0D%0A');
    const mailtoLink = `mailto:${emails.join(",")}?cc=${encodeURIComponent(ccAddress)}&subject=${encodeURIComponent(subject)}&body=${bodyParam}`;

    const a = document.createElement("a");
    a.href = mailtoLink;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  } catch (error) {
    console.error("Error fetching representatives:", error);
    alert("Something went wrong looking up your representatives. Please double-check the postcode.");
  }
};

/* Select all */
document.getElementById("selectAll").addEventListener("click", function () {
  toggleAllIssues(this);
});

/* Init */
init();
</script>
</body>
</html>
