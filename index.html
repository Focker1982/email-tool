<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tell Them This Isn‚Äôt Working</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h1 {
      text-align: center;
      font-size: 2.8em;
      color: #cc0000;
      margin-bottom: 20px;
    }
    .intro {
      background: #e7f1fc;
      padding: 15px 20px;
      border-left: 5px solid #0051a3;
      border-radius: 5px;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: inherit;
      min-height: 44px;
    }
    textarea {
      resize: vertical;
    }
    input:focus,
    textarea:focus,
    button:focus {
      outline: 2px solid #005fa3;
      outline-offset: 2px;
    }
    .issue-list {
      border: 1px solid #ccc;
      background: #f1f1f1;
      padding: 15px 20px;
      margin-top: 20px;
      border-radius: 5px;
    }
    .issue-list label {
      font-weight: 600;
      margin: 8px 0;
      font-size: 1.05em;
      display: flex;
      align-items: center;
    }
    .issue-list input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    button {
      margin-top: 25px;
      padding: 14px 24px;
      font-size: 1.1em;
      background-color: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      transition: background-color 0.3s ease;
      min-height: 44px;
      font-family: inherit;
    }
    button:hover {
      background-color: #005fa3;
    }
    #mailtoLink {
      display: inline-block;
      margin-top: 30px;
      font-weight: bold;
      font-size: 1.1em;
      background-color: #0077cc;
      color: white;
      padding: 12px 18px;
      border-radius: 6px;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }
    #mailtoLink:hover {
      background-color: #005fa3;
    }
    footer {
      margin-top: 50px;
      border-top: 1px solid #ddd;
      padding-top: 20px;
      font-size: 0.95em;
      color: #444;
    }
    @media (max-width: 600px) {
      body {
        padding: 20px;
      }
      label {
        font-size: 1.05em;
      }
      input[type="text"],
      textarea {
        font-size: 1em;
        padding: 12px;
      }
      button {
        font-size: 1em;
        padding: 12px 20px;
      }
    }
  </style>
</head>
<body>
  <div style="background: linear-gradient(90deg, #0051a3, #0077cc); padding: 30px 20px; border-radius: 12px; text-align: center; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <h1 style="color: white; font-size: 2.5em; margin: 0;">Tell Them This Isn‚Äôt Working</h1>
    <p style="color: #e0f0ff; font-size: 1.1em; margin-top: 8px;">Real Voices. Real Streets. Real Problems.</p>
  </div>

  <div class="intro" style="background: #f0f5ff; border-left: 5px solid #003f7d; margin-top: 40px;">
    <strong>Why does this tool exist?</strong><br><br>
    This tool makes it easy to add your voice to the campaign ‚Äî without needing to write from scratch. Every message it creates is unique, personal, and harder for MSPs and councillors to ignore or dismiss as copy-and-paste. That‚Äôs intentional. We want them to feel the pressure, hear the variety of real-life concerns, and see the volume of opposition that‚Äôs building.
  </div>

  <form>
    <label for="name">Your Name:</label>
    <input type="text" id="name" placeholder="e.g. Robert Bruce" autocomplete="name" required>

    <label for="address">Your Address:</label>
    <input type="text" id="address" placeholder="e.g. 6 Charlotte Square" autocomplete="street-address" required>

    <label for="postcode">Postcode:</label>
    <input type="text" id="postcode" placeholder="e.g. EH2 4DR" autocomplete="postal-code" required>

    <div class="issue-list">
      <strong>Select the concerns that affect your street:</strong>
      <label><input type="checkbox" id="selectAll" onclick="toggleAllIssues(this)"> üîò Select all</label>
      <label><input type="checkbox" value="emergency"> üöë Emergency vehicles could be blocked</label>
      <label><input type="checkbox" value="accessibility"> ‚ôøÔ∏è Accessibility needs not considered</label>
      <label><input type="checkbox" value="prams"> üßí Children and prams forced to share reduced road space</label>
      <label><input type="checkbox" value="bins"> üöÆ Bin collections missed or disrupted</label>
      <label><input type="checkbox" value="elderly"> üßì Elderly residents struggling with distance to car</label>
      <label><input type="checkbox" value="visitors"> üè† Visitors and tradespeople can‚Äôt park</label>
      <label><input type="checkbox" value="danger"> ‚ö†Ô∏è Danger now worse than before</label>
      <label><input type="checkbox" value="blocked"> üóëÔ∏è Pavements already blocked by council bins</label>
      <label><input type="checkbox" value="gardens"> üå± People paving over gardens due to pressure for parking</label>
      <label><input type="checkbox" value="blanket"> ‚ùå One‚Äësize‚Äëfits‚Äëall enforcement</label>
      <label><input type="checkbox" value="consultation"> üßæ Limited consultation</label>
      <label><input type="checkbox" value="cohesion"> üß± Social cohesion under strain</label>
      <label><input type="checkbox" value="opposeIdeology"> üõë Set aside 20‚Äëminute city‚Äìstyle frameworks</label>
      <label><input type="checkbox" value="blanket20mph"> üöó Blanket 20mph applied without local tailoring</label>
    </div>

    <label for="other">Write your own concerns:</label>
    <textarea id="other" rows="4" placeholder="Write anything else you want to include..."></textarea>

    <button type="button" onclick="generateEmail()">Open Email</button>
  </form>

  <footer>
    <p>This tool helps you contact your MSPs and councillors about the practical effects of the pavement parking ban on your street. You can personalise the content once it opens in your email client. Every email it generates is dynamic ‚Äî the subject line, the phrasing, and the examples all change each time you use it.</p>
  </footer>

<script>
/* === UPDATED ISSUES ONLY (everything else unchanged) === */
var issues = {
  emergency: [
    "Forcing all cars onto the road removes passing and turning space when seconds matter for blue-light access.",
    "Once parking fills the carriageway, fire and ambulance vehicles struggle at pinch points and response times can slip.",
    "Critical space and turning circles are lost when the road is narrowed by displaced parking ‚Äî that‚Äôs an emergency access risk."
  ],
  accessibility: [
    "Many residents, including the elderly and those recovering from injury, rely on being able to park near their homes. With limited legal alternatives, the ban makes daily life more difficult for people who already face mobility challenges.",
    "This policy creates unfair barriers for anyone with reduced mobility. There are no practical nearby alternatives for those who can‚Äôt easily walk longer distances, and the result is a less accessible environment ‚Äî not a more inclusive one.",
    "The pavement parking ban overlooks the people it claims to protect. Those with walking aids, temporary injuries, or pushchairs now face longer, more difficult routes between their car and their door ‚Äî often with no safe option."
  ],
  prams: [
    "On streets where pavements are already obstructed or uneven, full on-road parking forces prams and young children into the carriageway, making every journey riskier.",
    "Families used to navigate safely with prams or young kids by sharing space carefully. Now, displaced parking leaves less road space and no safe workaround.",
    "Rather than protecting families, this policy pushes children and prams into live traffic where partial kerb parking once gave them a buffer."
  ],
  bins: [
    "The current setup makes waste collection harder, not easier. Large vehicles have to squeeze through narrow gaps or mount the kerb ‚Äî increasing the risk of scrapes, delays, and missed collections.",
    "It‚Äôs obvious this layout puts bin collection at risk. Narrowed roads and awkward angles force council vehicles into difficult positions ‚Äî often driving up onto pavements to get past.",
    "This ban affects not just residents but essential services too. Bin lorries will have more difficulty accessing streets fully occupied by on-road parking, and damage to parked cars becomes more likely as a result."
  ],
  elderly: [
    "For older residents, having to walk further with shopping or mobility issues is a serious challenge. The policy ignores this reality and forces a level of physical strain that many simply can‚Äôt manage day-to-day.",
    "The distance between car and home now matters more than ever ‚Äî and for elderly people, that extra walk isn‚Äôt just inconvenient, it‚Äôs a real obstacle. We should be supporting them, not sidelining their needs.",
    "If you live with limited mobility, even a short walk can be daunting. Removing nearby parking makes it harder for older residents to stay independent ‚Äî and that doesn‚Äôt feel like progress."
  ],
  visitors: [
    "When family, friends, trades or local businesses can‚Äôt park nearby, everyday life suffers ‚Äî from childcare and school runs to helping an older relative.",
    "Restricting short-stay parking makes it harder for families to connect, friends to visit, and local services to deliver ‚Äî it chips away at the fabric of community.",
    "Losing the ability to stop close to someone‚Äôs home undermines everyday support networks ‚Äî grandparents helping with children, friends checking in, and local businesses or trades providing essential services."
  ],
  danger: [
    "Instead of improving safety, the new layout has increased tension on the road. Visibility is worse, space is tighter, and what used to be a calm residential route now feels more stressful for drivers and pedestrians alike.",
    "This policy hasn‚Äôt made our street safer. It‚Äôs created narrower lanes, reduced escape space for pedestrians, and made passing or reversing more dangerous than before.",
    "By forcing all parking onto the road, the policy increases the chance of collisions and close calls ‚Äî particularly where visibility is already limited. That‚Äôs not what safer streets look like."
  ],
  blocked: [
    "We‚Äôre banned from using the pavement to keep the road clear, yet council bins block pavements for days at a time ‚Äî reducing road space further when all cars are pushed onto it.",
    "Pavements can be impassable for days due to council bin storage, but residents are penalised for the same thing when trying to keep the street workable.",
    "It makes no sense to ban partial pavement use while council bins regularly block them ‚Äî and now all that space is lost on the road as well."
  ],
  gardens: [
    "The pressure to find legal parking is leading some residents to pave over front gardens, harming drainage, biodiversity and the character of the street.",
    "More hardstanding means worse drainage, less greenery, and a less welcoming street scene ‚Äî an avoidable side-effect of inflexible rules.",
    "Driveway conversions are becoming more common, not because residents want them, but because they feel forced. The result is a harder, less green street with higher flood risk."
  ],
  blanket: [
    "The same rule is being applied to all streets, no matter their layout or history of issues. That‚Äôs not enforcement ‚Äî that‚Äôs automation. Residents deserve better than one-size-fits-all punishment.",
    "By criminalising parking that worked safely for years, this policy alienates responsible residents. Enforcement should be focused on real obstructions ‚Äî not routine, practical parking.",
    "A universal ban treats all situations the same, regardless of context. We need flexibility and discretion ‚Äî not robotic enforcement that ignores lived experience."
  ],
  consultation: [
    "This policy was introduced without meaningful consultation at the street level. Residents like us have been left out of the discussion entirely, despite being directly affected.",
    "There‚Äôs been no honest engagement with our community. People were not asked how the ban would impact them ‚Äî they were simply told after the fact.",
    "A major change like this should include local voices. Instead, it‚Äôs been rolled out from the top down, with no opportunity to raise concerns before it hit the ground."
  ],
  opposeIdeology: [
    "I do not support the application of 20-minute city‚Äìstyle planning where it restricts everyday access. This approach should be removed from local transport policy.",
    "20-minute city frameworks should not be used to shape street-level parking or access rules. They do not reflect the needs of residents in practice.",
    "I reject the use of 20-minute city principles in local access planning. Where applied, they should be withdrawn in favour of practical, street-tested solutions."
  ],
  blanket20mph: [
    "I do not support a universal 20 mph speed limit. It should be reversed in favour of targeted limits where they are genuinely needed.",
    "Blanket 20 mph zones are inappropriate and should be replaced with speed management based on actual local risk.",
    "This area would be better served by retaining existing speed limits. I do not support the proposal of a universal 20 mph speed limit."
  ],
  cohesion: [
    "Restrictions that remove informal arrangements can strain cooperation between residents.",
    "Changes to parking rules will create disputes over limited space and parking.",
    "Maintaining goodwill is easier when local solutions are supported alongside policy."
  ]
};
</script>

<script>
var subjectLines = [
  "Request for review of pavement parking policy",
  "Pause and review to improve street access",
  "Local impacts and needed adjustments to parking rules",
  "Evidence from residents on pavement parking changes",
  "Making parking rules work for all users",
  "Balancing safety and access on local streets",
  "Call for practical review of parking restrictions",
  "How to deliver safer, more accessible streets",
  "Concerns about current pavement parking approach",
  "Improving policy outcomes through local review",
  "Ensuring parking policy matches real street conditions",
  "Request for pause before full enforcement",
  "Working together to fix unintended impacts",
  "Reviewing the impact on residents and services",
  "Practical solutions for safer local streets"
];
</script>

<script>
async function init() {
  window.isReady = false;

  const mspData = await fetch('mspContacts.json').then(res => res.json());

  // Normalise helper
  const normalize = str => str?.toLowerCase().replace(/[^a-z0-9]/g, '').trim();
  window.normalize = normalize;

  window.apiKey = "6946df58f97fd1b9aad7493a65c4cf8cbc8ddb3b";
  window._mspData = mspData;

  const normalizedRegions = {};
  Object.keys(mspData.regions).forEach(regionName => {
    normalizedRegions[normalize(regionName)] = mspData.regions[regionName];
  });
  mspData.regions = normalizedRegions;

  window.mspData = mspData;
  window.isReady = true;
}

function toggleAllIssues(source) {
  const checkboxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  checkboxes.forEach(cb => {
    if (cb.id !== 'selectAll') cb.checked = source.checked;
  });
}

async function getEmailsFromPostcode(postcode) {
  const url = `https://mapit.mysociety.org/postcode/${encodeURIComponent(postcode)}?api_key=${window.apiKey}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Postcode lookup failed.");
  const data = await res.json();
  const areas = data.areas;

  let spc = null, spe = null;
  for (const area of Object.values(areas)) {
    if (area.type === "SPC") spc = area.name;
    if (area.type === "SPE") spe = area.name;
  }

  const mspKey = Object.keys(window._mspData.constituencies).find(
    key => window.normalize(key) === window.normalize(spc)
  );
  const msp = mspKey ? window._mspData.constituencies[mspKey] : null;
  const regionalMSPs = window._mspData.regions[window.normalize(spe)] || [];

  const normalizedPostcode = window.normalize(postcode);
  const postcodePrefix = postcode.trim().toUpperCase().split(' ')[0];

  let councillors = [];
  const jsPath = `data/${postcodePrefix}.js`;
  try {
    await new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src = jsPath;
      script.onload = () => resolve();
      script.onerror = () => reject(`Failed to load script: ${jsPath}`);
      document.head.appendChild(script);
    });
    councillors = window.postcodeToWardKey?.[normalizedPostcode] || [];
  } catch (err) {
    console.warn(err);
  }

  return { msps: [msp, ...regionalMSPs].filter(Boolean), councillors };
}

window.generateEmail = async function () {
  if (!window.isReady) {
    alert("Still loading data. Please wait a moment and try again.");
    return;
  }

  const name = document.getElementById("name").value.trim();
  const address = document.getElementById("address").value.trim();
  const postcode = document.getElementById("postcode").value.trim();
  const other = document.getElementById("other").value.trim();

  const allCheckboxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  const checkboxes = Array.from(allCheckboxes).filter(cb => cb.checked && cb.id !== 'selectAll');

  if (!name || !address || !postcode) {
    alert("Please fill in your name, address, and postcode.");
    return;
  }
  if (checkboxes.length === 0 && !other) {
    alert("Please select at least one concern or fill in the other box.");
    return;
  }

  const newline = '\n\n';
  const selectedSubjects = checkboxes.map(cb => cb.value);
  const chosenLines = selectedSubjects.map(issue => {
    const options = issues[issue];
    return options[Math.floor(Math.random() * options.length)];
  });

  if (other) chosenLines.push('In addition, ' + other.trim());

  const mitigation = "I am asking Councillors and MSPs to work together to fix this quickly. Please pause enforcement where it creates risk or reduces access, lead a rapid, evidence‚Äëled review with residents and essential services, and make the necessary changes in both arenas ‚Äî update local traffic orders, exemptions and enforcement practice, and press Ministers for national amendments so legislation and guidance reflect real‚Äëworld conditions. The aim is simple: safe, genuinely accessible streets without avoidable harm to residents, services or the street environment.";
  const message = `Dear MSPs and Councillors,${newline}My name is ${name}, and I live at ${address}, ${postcode}.${newline}These rules are affecting everyday access and safety on our street. Residents have adapted over the years to keep streets workable for everyone, but these changes risk undoing that balance. The impacts being reported include:${newline}${chosenLines.join(newline)}${newline}${mitigation}${newline}Yours sincerely,${newline}${name}`;
  const subject = subjectLines[Math.floor(Math.random() * subjectLines.length)];

  try {
    const repData = await getEmailsFromPostcode(postcode);
    const emails = [];
    if (repData.msps?.length) repData.msps.forEach(m => { if (m.email) emails.push(m.email); });
    if (repData.councillors?.length) repData.councillors.forEach(c => { if (c.email) emails.push(c.email); });

    if (emails.length === 0) {
      alert("We couldn‚Äôt find any email contacts for that postcode.");
      return;
    }

    const ccAddress = "thepavementtrap@gmail.com";
    const body = message.replace(/\n/g, '%0D%0A');
    const mailtoLink = `mailto:${emails.join(",")}?cc=${encodeURIComponent(ccAddress)}&subject=${encodeURIComponent(subject)}&body=${body}`;

    const tempLink = document.createElement("a");
    tempLink.href = mailtoLink;
    tempLink.style.display = "none";
    document.body.appendChild(tempLink);
    tempLink.click();
    document.body.removeChild(tempLink);

    setTimeout(() => {
      alert("If your email app didn‚Äôt open, please check your browser settings or copy the text manually.");
    }, 1000);
  } catch (error) {
    console.error("Error fetching representatives:", error);
    alert("Something went wrong looking up your representatives. Please double-check the postcode.");
  }
};

document.getElementById("selectAll").addEventListener("click", function () {
  const isChecked = this.checked;
  const checkboxes = document.querySelectorAll(".issue-list input[type='checkbox']");
  checkboxes.forEach(cb => { if (cb.id !== 'selectAll') cb.checked = isChecked; });
});

init();
</script>
</body>
</html>
